<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="logo.png">
    <meta property="og:image" content="logo.png">
    <meta property="og:title" content="IQ Ø«Ù‚Ø§ÙØ© - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ©">
    <meta property="og:description" content="Ø§Ø®ØªØ¨Ø± Ø°ÙƒØ§Ø¡Ùƒ ÙˆÙ…Ø¹Ù„ÙˆÙ…Ø§ØªÙƒ Ø§Ù„Ø¹Ø§Ù…Ø© ÙÙŠ Ø±Ø­Ù„Ø© Ù…Ù…ØªØ¹Ø© Ø¹Ø¨Ø± Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª.">
    
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">

    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>
    
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3940256099942544" crossorigin="anonymous"></script>
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>IQ Ø«Ù‚Ø§ÙØ© - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ©</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&family=Poppins:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --gold: #ffd700;
            --blue: #0ea5e9;
            --glass: rgba(255, 255, 255, 0.1);
            --dark-glass: rgba(0, 0, 0, 0.85);
            --danger: #ff4d4d;
        }

        /* ØªÙ†Ø¨ÙŠÙ‡ Ø­Ø§Ù„Ø© Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª */
        #offline-warning {
            position: fixed; top: 0; left: 0; width: 100%;
            background: var(--danger); color: white;
            text-align: center; padding: 10px; font-size: 0.9rem;
            z-index: 10000; display: none; font-weight: bold;
        }

        body, html {
            margin: 0; padding: 0; height: 100%; width: 100%;
            font-family: 'Cairo', sans-serif; color: white;
            overflow: hidden;
            background: #1a1a1a url('athena.jpg') no-repeat center center;
            background-size: cover;
            background-attachment: fixed;
        }

        .overlay {
            position: fixed; inset: 0;
            background: rgba(0, 0, 0, 0.55);
            z-index: 1;
        }

        .top-bar {
            position: fixed; top: 0; width: 100%; padding: 10px 15px;
            display: none; justify-content: space-between; align-items: center; z-index: 1000;
            background: var(--glass);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            box-sizing: border-box; 
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding-top: env(safe-area-inset-top);
        }

        .top-right { display: flex; align-items: center; gap: 8px; }
        .top-left { display: flex; align-items: center; gap: 8px; }

        .player-badge {
            display: flex; align-items: center; gap: 6px;
            background: rgba(255,255,255,0.08); padding: 4px 10px;
            border-radius: 50px; border: 1px solid rgba(255,255,255,0.1);
        }
        .player-avatar {
            width: 24px; height: 24px; background: var(--gold);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            color: black; font-weight: 900; font-size: 0.7rem;
        }

        .hearts-group {
            display: flex; align-items: center; gap: 2px;
            background: rgba(255, 77, 77, 0.1);
            border: 1px solid rgba(255, 77, 77, 0.3);
            padding: 2px 4px; border-radius: 50px;
        }

        .stat-badge {
            display: flex; align-items: center; gap: 4px;
            padding: 4px 8px; border-radius: 50px;
            font-size: 0.85rem; font-weight: 900;
        }

        .recharge-mini-btn {
            background: #ff4d4d; color: white; border: none;
            width: 28px; height: 28px; border-radius: 50%;
            font-size: 1.1rem; cursor: pointer; font-weight: bold;
            display: flex; align-items: center; justify-content: center;
        }

        .exit-arrow-btn {
            position: fixed; top: 70px; right: 15px;
            background: var(--gold); color: black; border: none;
            width: 45px; height: 45px; border-radius: 12px;
            font-size: 1.5rem; font-weight: 900; cursor: pointer;
            z-index: 1001; display: none; align-items: center; justify-content: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }

        .icon-btn {
            background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.1);
            width: 36px; height: 36px; border-radius: 10px; cursor: pointer; 
            display: flex; align-items: center; justify-content: center;
            color: white; transition: 0.2s; font-size: 1rem;
        }

        .name-input-screen { position: fixed; inset: 0; background: var(--dark-glass); backdrop-filter: blur(15px); z-index: 5000; display: none; align-items: center; justify-content: center; }
        .name-box { background: #111; padding: 40px 30px; border-radius: 30px; border: 2px solid var(--gold); text-align: center; width: 85%; max-width: 400px; }
        .name-box input { width: 100%; padding: 15px; border-radius: 15px; border: 1px solid #333; margin: 20px 0; font-size: 1.2rem; text-align: center; background: #222; color: white; box-sizing: border-box; font-family: 'Cairo'; }
        .screen { position: relative; z-index: 10; height: 100vh; display: none; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 20px; box-sizing: border-box; }
        .active { display: flex; }
        .fact-container { background: var(--glass); padding: 25px; border-radius: 25px; margin: 20px; max-width: 400px; max-height: 180px; overflow-y: auto; border: 1px solid rgba(255,255,255,0.1); }
        .gold-btn { background: var(--gold); color: black; border: none; padding: 20px 100px; border-radius: 60px; font-size: 1.4rem; font-weight: 900; cursor: pointer; transition: 0.3s; box-shadow: 0 0 20px rgba(255, 215, 0, 0.3); animation: btnPulse 2s infinite; }
        .gold-btn:disabled { background: #444; color: #888; cursor: not-allowed; animation: none; box-shadow: none; }
        @keyframes btnPulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        .lang-toggle-container { margin-bottom: 25px; display: flex; justify-content: center; flex-wrap: wrap; gap: 10px; }
        .lang-btn { background: var(--glass); border: 1px solid rgba(255,255,255,0.2); color: white; padding: 10px 15px; border-radius: 15px; cursor: pointer; font-weight: 900; }
        .lang-btn.active-lang { background: var(--blue); border-color: var(--blue); }
        .cat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 100%; max-width: 450px; }
        .cat-btn { background: var(--glass); backdrop-filter: blur(15px); padding: 25px 10px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.1); cursor: pointer; font-weight: 900; transition: 0.3s; color: white; font-size: 1.1rem; }
        
        .map-view { 
            width: 100%; 
            height: 100vh; 
            overflow-y: auto; 
            padding: 150px 0; 
            display: flex; 
            flex-direction: column-reverse; 
            align-items: center; 
            gap: 40px; 
            scroll-behavior: smooth;
            position: relative;
        }
        
        .map-view svg {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            z-index: -1;
        }

        .lvl-node { 
            width: 80px; height: 80px; border-radius: 50%; 
            background: rgba(255, 255, 255, 0.05); 
            border: 4px solid rgba(255, 255, 255, 0.2); 
            display: flex; align-items: center; justify-content: center; 
            font-size: 1.6rem; font-weight: 900; cursor: default; 
            transition: 0.4s; color: rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(5px); flex-shrink: 0;
            position: relative;
            z-index: 2;
        }

        .lvl-node.completed { 
            background: var(--gold); 
            border-color: #b8860b; 
            color: black; 
            cursor: pointer;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.5);
        }

        .lvl-node.current { 
            background: white; 
            border-color: var(--gold); 
            color: black; 
            cursor: pointer;
            animation: pulseWhite 2s infinite; 
            box-shadow: 0 0 25px rgba(255, 255, 255, 0.7);
            z-index: 5;
        }

        @keyframes pulseWhite { 
            0%, 100% { transform: scale(1); } 
            50% { transform: scale(1.15); } 
        }

        .quiz-container { position: fixed; bottom: -100%; left: 0; width: 100%; background: rgba(15, 15, 15, 0.98); backdrop-filter: blur(30px); border-radius: 35px 35px 0 0; border-top: 3px solid var(--gold); padding: 30px 20px; box-sizing: border-box; z-index: 2000; transition: 0.6s cubic-bezier(0.19, 1, 0.22, 1); max-height: 75vh; overflow-y: auto; }
        .quiz-container.show { bottom: 0; }
        .ans-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 25px; }
        .ans-btn { background: rgba(255,255,255,0.07); padding: 18px; border-radius: 15px; cursor: pointer; border: 1px solid rgba(255,255,255,0.1); font-weight: bold; text-align: center; color: white; }
        .ans-btn.wrong { background: #ef4444 !important; }
        .ans-btn.correct { background: #10b981 !important; }
        .leaderboard-modal { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; background: rgba(0,0,0,0.9); z-index: 6000; }
        .leaderboard-box { background: #111; padding: 25px; border-radius: 25px; width: 90%; max-width: 400px; border: 1px solid var(--gold); }
        .leader-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #333; }
        .ad-modal { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; background: rgba(0,0,0,0.9); z-index: 4000; }
        .ad-box { background: #222; padding: 35px; border-radius: 25px; width: 85%; max-width: 400px; text-align: center; border: 2px solid var(--gold); }
        .glass-btn { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; padding: 12px 25px; border-radius: 15px; cursor: pointer; }
        #regen-timer { font-size: 0.65rem; color: #ddd; margin-right: 3px; font-weight: normal; }

        .logo-wrapper { margin-bottom: 30px; perspective: 1000px; }
        .main-logo-styled { font-size: 4.5rem; font-weight: 900; margin: 0; letter-spacing: -2px; background: linear-gradient(180deg, #fff 30%, var(--gold) 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; filter: drop-shadow(0 10px 15px rgba(0,0,0,0.5)); animation: logoFloat 3s ease-in-out infinite; display: inline-block; }
        @keyframes logoFloat { 0%, 100% { transform: translateY(0) rotateX(0); } 50% { transform: translateY(-10px) rotateX(5deg); } }
        .logo-subtitle { display: block; font-size: 0.9rem; color: var(--gold); letter-spacing: 5px; margin-top: -10px; font-weight: 700; opacity: 0.8; text-transform: uppercase; }
    </style>
</head>
<body>

<div id="offline-warning"></div>

<audio id="bg-audio" src="./jazz-music-466491.mp3" loop></audio>
<div class="overlay"></div>

<button id="main-exit-btn" onclick="goBack()" class="exit-arrow-btn">â”</button>

<div id="top-bar" class="top-bar">
    <div class="top-right">
        <div class="player-badge">
            <div class="player-avatar" id="avatar-char">?</div>
            <span id="player-name-display" style="font-weight: bold; font-size: 0.75rem;">...</span>
        </div>
        <div class="hearts-group">
            <div class="stat-badge" style="color: #ff4d4d;">
                <span>â¤ï¸</span> <span id="hearts-val">5</span>
                <span id="regen-timer"></span>
            </div>
            <button onclick="showAdModal('manual')" class="recharge-mini-btn">+</button>
        </div>
        <div class="stat-badge" style="color: var(--gold); background: rgba(255,215,0,0.1); border: 1px solid rgba(255,215,0,0.2);">
            <span>ğŸ†</span> <span id="score-val">0</span>
        </div>
    </div>
    <div class="top-left">
        <button id="mute-btn" class="icon-btn">ğŸ”Š</button>
    </div>
</div>

<div id="name-screen" class="name-input-screen">
    <div class="name-box">
        <h2 style="color: var(--gold); margin-top: 0;">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ!</h2>
        <p>Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ Ù„ØªØ¨Ø¯Ø£ Ø±Ø­Ù„Ø© Ø§Ù„Ø«Ù‚Ø§ÙØ© ÙˆØªÙ†Ø§ÙØ³ ÙÙŠ Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠ</p>
        <input type="text" id="player-name-input" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ Ù‡Ù†Ø§..." maxlength="15">
        <button onclick="submitName()" class="gold-btn" style="padding: 15px 50px;">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¢Ù†</button>
    </div>
</div>

<div id="scr-start" class="screen active">
    <div class="logo-wrapper">
        <h1 id="main-logo" class="main-logo-styled">IQ Ø«Ù‚Ø§ÙØ©</h1>
        <span id="logo-sub" class="logo-subtitle">GLOBAL EDITION</span>
    </div>
    <div class="fact-container"><p id="fact-txt" style="font-size: 1.1rem; line-height: 1.6;">...</p></div>
    <div style="display: flex; flex-direction: column; gap: 15px;">
        <button id="btn-start" onclick="showCats()" class="gold-btn">Ø§Ø³ØªÙ…Ø±Ø§Ø±</button>
        <button id="btn-leaderboard" onclick="openLeaderboard()" class="glass-btn" style="font-weight: 900; color: var(--gold);">ğŸ† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ† Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ©</button>
    </div>
</div>

<div id="scr-cats" class="screen">
    <h2 id="txt-select-cat" style="margin-bottom: 20px; font-size: 1.8rem;">Ø§Ø®ØªØ± Ø§Ù„ØªØµÙ†ÙŠÙ</h2>
    <div class="lang-toggle-container">
        <button id="btn-lang-ar" class="lang-btn" onclick="setLanguage('ar')">Ar ğŸ‡¸ğŸ‡¦</button>
        <button id="btn-lang-en" class="lang-btn" onclick="setLanguage('en')">En ğŸ‡ºğŸ‡¸</button>
        <button id="btn-lang-es" class="lang-btn" onclick="setLanguage('es')">Es ğŸ‡ªğŸ‡¸</button>
        <button id="btn-lang-fr" class="lang-btn" onclick="setLanguage('fr')">Fr ğŸ‡«ğŸ‡·</button>
    </div>
    <div class="cat-grid" id="cat-grid-container"></div>
</div>

<div id="scr-map" class="screen" style="padding:0; justify-content: flex-start; overflow: hidden;">
    <div class="map-view" id="map-cont"></div>
</div>

<div id="leaderboard-modal" class="leaderboard-modal">
    <div class="leaderboard-box">
        <h2 id="txt-leaderboard-title" style="color: var(--gold); text-align: center; margin-bottom: 20px;">Ø£ÙØ¶Ù„ 10 Ù„Ø§Ø¹Ø¨ÙŠÙ† ÙÙŠ Ø§Ù„Ø¹Ø§Ù„Ù…</h2>
        <div id="leaderboard-list"></div>
        <button id="btn-close-leader" onclick="closeLeaderboard()" class="glass-btn" style="width: 100%; margin-top: 15px;">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
</div>

<div class="quiz-container" id="quiz-ui">
    <div id="q-text" style="font-size: 1.4rem; font-weight: bold; line-height: 1.5;"></div>
    <div class="ans-grid" id="ans-box"></div>
    <div class="controls-row" style="margin-top:25px; display:flex; justify-content:center;">
        <button id="remove-two-btn" class="glass-btn"></button>
    </div>
</div>

<div class="ad-modal" id="ad-modal">
    <div class="ad-box">
        <h3 id="txt-no-hearts" style="color:var(--gold); font-size: 1.5rem;"></h3>
        <p id="txt-ad-desc"></p>
        <div id="ad-timer" style="display:none; font-size: 2rem; color: var(--gold); font-weight: bold; margin: 15px 0;">5</div>
        <div style="margin-top:25px; display: flex; flex-direction: column; gap: 10px;">
            <button id="watch-ad-btn" class="gold-btn" style="padding: 15px;">ğŸ“º Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†</button>
            <button onclick="closeAdModal()" class="glass-btn" id="txt-later"></button>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = { apiKey: "AIzaSyCIXq5egNrR0dS5YI2L4BFnm3IGa11128Q", databaseURL: "https://iq-culture-default-rtdb.firebaseio.com/", projectId: "iq-culture" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSJ4RCU1_iXMqLS3ApB1g8SjSrL2hbIAv-1VniqdMElnalov--mSDTpe9rjMxaWGCuP6gpxWV7OZDe1/pub?output=csv";

    const MAX_HEARTS = 5;
    const REGEN_TIME = 5 * 60 * 1000;

    let gameState = {
        playerName: localStorage.getItem('iq_player_name') || "",
        score: parseInt(localStorage.getItem('iq_score')) || 0,
        progress: JSON.parse(localStorage.getItem('iq_prog')) || {}, 
        currentCat: '', questions: [], activeIdx: 0,
        hearts: parseInt(localStorage.getItem('iq_hearts')) || MAX_HEARTS,
        lastHeartTime: parseInt(localStorage.getItem('iq_last_heart_time')) || Date.now(),
        muted: (localStorage.getItem('iq_muted') === 'true') || false,
        usedRemove: JSON.parse(localStorage.getItem('iq_rem_used') || '{}'),
        lang: localStorage.getItem('iq_lang') || 'ar',
        adCounter: 0 
    };

    const langConfig = {
        ar: { dir: "rtl", font: "'Cairo', sans-serif", logo: "IQ Ø«Ù‚Ø§ÙØ©", sub: "Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ©", start: "Ø§Ø³ØªÙ…Ø±Ø§Ø±", select: "Ø§Ø®ØªØ± Ø§Ù„ØªØµÙ†ÙŠÙ", recharge: "+", noHearts: "Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù‚Ù„ÙˆØ¨!", adDesc: "Ø´Ø§Ù‡Ø¯ Ø¥Ø¹Ù„Ø§Ù† Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù‚Ù„ÙˆØ¨ ÙƒØ§Ù…Ù„Ø©.", later: "Ø±Ø¨Ù…Ø§ Ù„Ø§Ø­Ù‚Ø§Ù‹", removeBtn: "Ø­Ø°Ù Ø®ÙŠØ§Ø±ÙŠÙ† (50 Ù†Ù‚Ø·Ø©)", factLoading: "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...", leaderboardBtn: "ğŸ† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ† Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ©", leaderboardTitle: "Ø£ÙØ¶Ù„ 10 Ù„Ø§Ø¹Ø¨ÙŠÙ† ÙÙŠ Ø§Ù„Ø¹Ø§Ù„Ù…", close: "Ø¥ØºÙ„Ø§Ù‚", offline: "âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª", factsGid: "605574246", cats: [{ name: "â³ Ø§Ù„ØªØ§Ø±ÙŠØ®", gid: "11216236", key: "history" }, { name: "ğŸŒ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠØ§", gid: "99625756", key: "geo" }, { name: "ğŸ§¬ Ø§Ù„Ø¹Ù„ÙˆÙ…", gid: "1843208636", key: "science" }, { name: "ğŸ’¡ Ø«Ù‚Ø§ÙØ© Ø¹Ø§Ù…Ø©", gid: "564130158", key: "general" }, { name: "âš½ Ø§Ù„Ø±ÙŠØ§Ø¶Ø©", gid: "0", key: "sports" }] },
        en: { dir: "ltr", font: "'Poppins', sans-serif", logo: "IQ Culture", sub: "GLOBAL EDITION", start: "Continue", select: "Select Category", recharge: "+", noHearts: "No Hearts!", adDesc: "Watch ad to get full hearts.", later: "Maybe later", removeBtn: "Remove 2 (50 pts)", factLoading: "Loading fact...", leaderboardBtn: "ğŸ† Global Leaderboard", leaderboardTitle: "Top 10 Players in the World", close: "Close", offline: "âš ï¸ No internet connection", factsGid: "259198059", cats: [{ name: "â³ History", gid: "1950805065", key: "history" }, { name: "ğŸŒ Geography", gid: "1899297807", key: "geo" }, { name: "ğŸ§¬ Science", gid: "407039200", key: "science" }, { name: "ğŸ’¡ General", gid: "1044248022", key: "general" }, { name: "âš½ Sports", gid: "1559005659", key: "sports" }] },
        es: { dir: "ltr", font: "'Poppins', sans-serif", logo: "IQ Cultura", sub: "EDICIÃ“N GLOBAL", start: "Continuar", select: "Seleccionar CategorÃ­a", recharge: "+", noHearts: "Â¡Sin Corazones!", adDesc: "Mira un anuncio para obtener corazones.", later: "MÃ¡s tarde", removeBtn: "Eliminar 2 (50 pts)", factLoading: "Cargando...", leaderboardBtn: "ğŸ† Tabla de LÃ­deres", leaderboardTitle: "Los 10 mejores jugadores", close: "Cerrar", offline: "âš ï¸ Sin conexiÃ³n a internet", factsGid: "1911794502", cats: [{ name: "â³ Historia", gid: "948777647", key: "history" }, { name: "ğŸŒ GeografÃ­a", gid: "1233201488", key: "geo" }, { name: "ğŸ§¬ Ciencia", gid: "2028449800", key: "science" }, { name: "ğŸ’¡ Cultura General", gid: "1662832315", key: "general" }, { name: "âš½ Deportes", gid: "1795176380", key: "sports" }] },
        fr: { dir: "ltr", font: "'Poppins', sans-serif", logo: "QI Culture", sub: "Ã‰DITION MONDIALE", start: "Continuer", select: "Choisir la CatÃ©gorie", recharge: "+", noHearts: "Plus de cÅ“urs !", adDesc: "Regardez une pub pour des cÅ“urs.", later: "Plus tard", removeBtn: "Supprimer 2 (50 pts)", factLoading: "Chargement...", leaderboardBtn: "ğŸ† Classement Mondial", leaderboardTitle: "Top 10 des meilleurs joueurs", close: "Fermer", offline: "âš ï¸ Pas de connexion internet", factsGid: "1356278776", cats: [{ name: "â³ Histoire", gid: "1692460075", key: "histoire" }, { name: "ğŸŒ GÃ©ographie", gid: "1888258036", key: "geo" }, { name: "ğŸ§¬ Sciences", gid: "1043839601", key: "science" }, { name: "ğŸ’¡ Culture GÃ©nÃ©rale", gid: "1000789609", key: "general" }, { name: "âš½ Sports", gid: "942675202", key: "sports" }] }
    };

    const audioEl = document.getElementById('bg-audio');
    const muteBtn = document.getElementById('mute-btn');

    // ÙˆØ¸ÙŠÙØ© Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ù…Ø¹ ØªØ±Ø¬Ù…Ø© Ø§Ù„Ø±Ø³Ø§Ù„Ø©
    function checkConnection() {
        const warning = document.getElementById('offline-warning');
        const startBtn = document.getElementById('btn-start');
        warning.innerText = langConfig[gameState.lang].offline;
        if (!navigator.onLine) {
            warning.style.display = 'block';
            if(startBtn) startBtn.disabled = true;
        } else {
            warning.style.display = 'none';
            if(startBtn) startBtn.disabled = false;
        }
    }
    window.addEventListener('online', checkConnection);
    window.addEventListener('offline', checkConnection);

    // Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ù…ÙˆØ³ÙŠÙ‚Ù‰ Ø¹Ù†Ø¯ Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„Ù„Ø¹Ø¨Ø© Ø£Ùˆ ØªØºÙŠÙŠØ± Ø§Ù„ØªØ¨ÙˆÙŠØ¨
    document.addEventListener("visibilitychange", function() {
        if (document.hidden) {
            audioEl.pause();
        } else {
            if (!gameState.muted) {
                audioEl.play().catch(() => {});
            }
        }
    });

    function goBack() {
        const quizUI = document.getElementById('quiz-ui');
        if (quizUI.classList.contains('show')) { quizUI.classList.remove('show'); return; }
        const mapScreen = document.getElementById('scr-map');
        const catsScreen = document.getElementById('scr-cats');
        if (mapScreen.classList.contains('active')) { switchScreen('scr-cats'); } 
        else if (catsScreen.classList.contains('active')) { 
            switchScreen('scr-start'); 
            document.getElementById('top-bar').style.display = 'none'; 
            document.getElementById('main-exit-btn').style.display = 'none'; 
        }
    }

    function init() {
        checkConnection();
        checkPlayerName(); applyLanguage(); updateUI();
        muteBtn.onclick = toggleMute;
        document.getElementById('remove-two-btn').onclick = useRemoveTwo;
        document.getElementById('watch-ad-btn').onclick = triggerRewardedAd;
        setInterval(checkHeartRegen, 1000);
    }

    function checkHeartRegen() {
        if (gameState.hearts < MAX_HEARTS) {
            const now = Date.now(); const diff = now - gameState.lastHeartTime;
            if (diff >= REGEN_TIME) { gameState.hearts++; gameState.lastHeartTime = now; save(); updateUI(); } 
            else {
                const remaining = Math.ceil((REGEN_TIME - diff) / 1000);
                const mins = Math.floor(remaining / 60); const secs = remaining % 60;
                const regenEl = document.getElementById('regen-timer');
                if(regenEl) regenEl.innerText = `${mins}:${secs < 10 ? '0' : ''}${secs}`;
            }
        } else { 
            const regenEl = document.getElementById('regen-timer');
            if(regenEl) regenEl.innerText = ""; 
            gameState.lastHeartTime = Date.now(); 
        }
    }

    function checkPlayerName() { if (!gameState.playerName) { document.getElementById('name-screen').style.display = 'flex'; } else { updatePlayerDisplay(); } }

    function submitName() {
        let input = document.getElementById('player-name-input').value.trim();
        if (input.length < 3) { alert(gameState.lang === 'ar' ? "Ø§Ù„Ø§Ø³Ù… Ù‚ØµÙŠØ± Ø¬Ø¯Ø§Ù‹!" : "Name too short!"); return; }
        gameState.playerName = input.substring(0, 15);
        localStorage.setItem('iq_player_name', gameState.playerName);
        document.getElementById('name-screen').style.display = 'none';
        updatePlayerDisplay(); save();
    }

    function updatePlayerDisplay() {
        const name = gameState.playerName || "...";
        document.getElementById('player-name-display').innerText = name;
        document.getElementById('avatar-char').innerText = name.charAt(0).toUpperCase();
    }

    function openLeaderboard() {
        const listCont = document.getElementById('leaderboard-list');
        listCont.innerHTML = '<p style="text-align:center;">...</p>';
        db.ref('leaderboard').orderByChild('score').limitToLast(10).once('value', (snapshot) => {
            let board = []; snapshot.forEach((child) => { board.push(child.val()); }); board.reverse(); 
            listCont.innerHTML = '';
            board.forEach((entry, i) => {
                let rank = (i === 0) ? "ğŸ¥‡" : (i === 1) ? "ğŸ¥ˆ" : (i === 2) ? "ğŸ¥‰" : (i + 1);
                const item = document.createElement('div');
                item.className = `leader-item`;
                item.innerHTML = `<div style="display:flex; align-items:center; gap:10px;"><span class="rank-tag">${rank}</span><span>${entry.name}</span></div><div style="color:var(--gold); font-weight:900;">${entry.score}</div>`;
                listCont.appendChild(item);
            });
            document.getElementById('leaderboard-modal').style.display = 'flex';
        });
    }

    function closeLeaderboard() { document.getElementById('leaderboard-modal').style.display = 'none'; }
    function setLanguage(l) { gameState.lang = l; localStorage.setItem('iq_lang', l); applyLanguage(); }

    function applyLanguage() {
        const conf = langConfig[gameState.lang];
        document.documentElement.dir = conf.dir; document.documentElement.lang = gameState.lang;
        document.body.style.fontFamily = conf.font; document.getElementById('main-logo').innerText = conf.logo;
        document.getElementById('logo-sub').innerText = conf.sub;
        document.getElementById('btn-start').innerText = conf.start; document.getElementById('txt-select-cat').innerText = conf.select;
        document.getElementById('txt-no-hearts').innerText = conf.noHearts;
        document.getElementById('txt-ad-desc').innerText = conf.adDesc; document.getElementById('txt-later').innerText = conf.later;
        document.getElementById('remove-two-btn').innerText = conf.removeBtn; document.getElementById('btn-leaderboard').innerText = conf.leaderboardBtn;
        document.getElementById('txt-leaderboard-title').innerText = conf.leaderboardTitle; document.getElementById('btn-close-leader').innerText = conf.close;
        document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active-lang'));
        document.getElementById(`btn-lang-${gameState.lang}`).classList.add('active-lang');
        checkConnection();
        loadFact(); renderCats();
    }

    function loadFact() {
        const conf = langConfig[gameState.lang]; const factBox = document.getElementById('fact-txt'); factBox.innerText = conf.factLoading;
        fetch(CSV + "&gid=" + conf.factsGid).then(r => r.text()).then(d => {
            const lines = d.split(/\r?\n/).slice(1);
            if (lines.length > 0) {
                const fact = lines[Math.floor(Math.random()*lines.length)].split(',')[0].replace(/"/g, '');
                factBox.innerText = fact;
            }
        }).catch(() => factBox.innerText = "...");
    }

    function renderCats() {
        const container = document.getElementById('cat-grid-container'); container.innerHTML = '';
        langConfig[gameState.lang].cats.forEach(c => {
            const btn = document.createElement('div'); btn.className = 'cat-btn';
            if(c.key === 'sports') btn.style.gridColumn = 'span 2';
            btn.innerText = c.name; btn.onclick = () => startCat(c.gid, c.key);
            container.appendChild(btn);
        });
    }

    function save() {
        localStorage.setItem('iq_score', gameState.score); localStorage.setItem('iq_prog', JSON.stringify(gameState.progress));
        localStorage.setItem('iq_hearts', gameState.hearts); localStorage.setItem('iq_last_heart_time', gameState.lastHeartTime);
        localStorage.setItem('iq_muted', gameState.muted); localStorage.setItem('iq_rem_used', JSON.stringify(gameState.usedRemove));
        if(gameState.playerName) db.ref('leaderboard/' + gameState.playerName).set({ name: gameState.playerName, score: gameState.score });
    }

    function updateUI() {
        document.getElementById('score-val').innerText = gameState.score;
        document.getElementById('hearts-val').innerText = gameState.hearts;
        muteBtn.innerText = gameState.muted ? 'ğŸ”‡' : 'ğŸ”Š'; updatePlayerDisplay();
    }

    function toggleMute() { gameState.muted = !gameState.muted; gameState.muted ? audioEl.pause() : audioEl.play(); save(); updateUI(); }

    function showCats() { 
        document.getElementById('top-bar').style.display = 'flex'; 
        document.getElementById('main-exit-btn').style.display = 'flex';
        if(!gameState.muted) audioEl.play().catch(()=>{}); 
        switchScreen('scr-cats'); 
    }

    function switchScreen(id) { document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); document.getElementById(id).classList.add('active'); }

    async function startCat(gid, name) {
        if(!navigator.onLine) return;
        gameState.currentCat = name; switchScreen('scr-map');
        try {
            const r = await fetch(CSV + "&gid=" + gid); const d = await r.text();
            gameState.questions = d.split(/\r?\n/).slice(1).map(row => {
                const c = row.split(',').map(x => x.trim().replace(/"/g, ''));
                return { q: c[0], opts: [c[1], c[2], c[3], c[4]], a: c[5] };
            }).filter(q => q.q);
            renderMap(true);
        } catch(e) { console.error(e); }
    }

    function renderMap(shouldScroll = false) {
        const cont = document.getElementById('map-cont');
        const progKey = `${gameState.lang}_${gameState.currentCat}`;
        const unlocked = gameState.progress[progKey] || 1;
        cont.innerHTML = '';
        gameState.questions.forEach((_, i) => {
            const levelNum = i + 1;
            const node = document.createElement('div');
            node.className = 'lvl-node'; node.innerText = levelNum;
            const offset = (i % 2 === 0) ? "40px" : "-40px";
            node.style.transform = `translateX(${offset})`;
            if (levelNum < unlocked) {
                node.classList.add('completed'); node.onclick = () => openQuiz(i);
            } else if (levelNum === unlocked) {
                node.classList.add('current'); node.id = "target-scroll-node"; 
                node.onclick = () => openQuiz(i);
            }
            cont.appendChild(node);
        });
        if (shouldScroll) {
            setTimeout(() => {
                const target = document.getElementById('target-scroll-node');
                if (target) target.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 100);
        }
    }

    function openQuiz(idx) {
        if(gameState.hearts <= 0) { showAdModal('hearts'); return; }
        gameState.activeIdx = idx; const q = gameState.questions[idx];
        document.getElementById('q-text').innerText = q.q;
        const box = document.getElementById('ans-box'); box.innerHTML = '';
        const usedKey = `${gameState.lang}_${gameState.currentCat}_${idx}`;
        document.getElementById('remove-two-btn').style.display = (gameState.score >= 50 && !gameState.usedRemove[usedKey]) ? 'block' : 'none';
        const letters = ['a', 'b', 'c', 'd'];
        let optionsList = q.opts.map((text, i) => { return { text: text, originalLetter: letters[i] }; });
        optionsList.sort(() => Math.random() - 0.5);
        optionsList.forEach((item) => {
            const b = document.createElement('div'); b.className = 'ans-btn'; b.innerText = item.text;
            b.onclick = () => checkAns(b, item.originalLetter, q.a); box.appendChild(b);
        });
        document.getElementById('quiz-ui').classList.add('show');
    }

    function checkAns(btn, selectedLetter, correctLetter) {
        const progKey = `${gameState.lang}_${gameState.currentCat}`;
        if(selectedLetter.toLowerCase().trim() === correctLetter.toLowerCase().trim()) {
            btn.classList.add('correct'); gameState.score += 10; gameState.adCounter++;
            if(gameState.adCounter >= 7) {
                gameState.adCounter = 0;
                if(gameState.activeIdx + 1 === (gameState.progress[progKey] || 1)) { gameState.progress[progKey] = (gameState.progress[progKey] || 1) + 1; }
                setTimeout(() => { document.getElementById('quiz-ui').classList.remove('show'); showAdModal('milestone'); }, 800);
            } else {
                if(gameState.activeIdx + 1 === (gameState.progress[progKey] || 1)) { gameState.progress[progKey] = (gameState.progress[progKey] || 1) + 1; }
                setTimeout(() => { document.getElementById('quiz-ui').classList.remove('show'); renderMap(false); }, 800);
            }
        } else {
            btn.classList.add('wrong'); gameState.hearts--;
            if (gameState.hearts === MAX_HEARTS - 1) { gameState.lastHeartTime = Date.now(); }
            if(gameState.hearts <= 0) { setTimeout(() => { document.getElementById('quiz-ui').classList.remove('show'); showAdModal('hearts'); }, 800); }
        }
        save(); updateUI();
    }

    function useRemoveTwo() {
        const q = gameState.questions[gameState.activeIdx]; const correctLetter = q.a.toLowerCase().trim();
        const btns = Array.from(document.querySelectorAll('.ans-btn')); let removedCount = 0;
        btns.forEach(btn => {
            const letters = ['a', 'b', 'c', 'd']; let isCorrect = false;
            q.opts.forEach((optText, index) => { if(optText === btn.innerText && letters[index] === correctLetter) isCorrect = true; });
            if(!isCorrect && removedCount < 2) { btn.style.visibility = 'hidden'; removedCount++; }
        });
        gameState.score -= 50; gameState.usedRemove[`${gameState.lang}_${gameState.currentCat}_${gameState.activeIdx}`] = true;
        document.getElementById('remove-two-btn').style.display = 'none'; save(); updateUI();
    }

    function showAdModal(type) { 
        const t = document.getElementById('txt-no-hearts'); const d = document.getElementById('txt-ad-desc');
        const watchBtn = document.getElementById('watch-ad-btn'); const conf = langConfig[gameState.lang];
        watchBtn.setAttribute('data-ad-type', type);
        if(type === 'milestone') {
            t.innerText = gameState.lang === 'ar' ? "Ø£Ø­Ø³Ù†Øª!" : "Great Progress!";
            d.innerText = gameState.lang === 'ar' ? "Ø£ÙƒÙ…Ù„Øª 7 Ø£Ø³Ø¦Ù„Ø©! Ø´Ø§Ù‡Ø¯ Ø¥Ø¹Ù„Ø§Ù†Ø§Ù‹ Ø³Ø±ÙŠØ¹Ø§Ù‹ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©." : "7 questions done! Watch a quick ad to continue.";
            watchBtn.innerText = gameState.lang === 'ar' ? "Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†" : "Watch Ad";
        } else {
            t.innerText = conf.noHearts; d.innerText = conf.adDesc;
            watchBtn.innerText = gameState.lang === 'ar' ? "ğŸ“º Ø´Ø­Ù† Ø§Ù„Ù‚Ù„ÙˆØ¨ ÙÙˆØ±Ø§Ù‹" : "ğŸ“º Refill Hearts Now";
        }
        document.getElementById('ad-modal').style.display = 'flex'; 
    }
    
    function closeAdModal() { document.getElementById('ad-modal').style.display = 'none'; renderMap(false); }

    function startAd() {
        let sec = 5; const btn = document.getElementById('watch-ad-btn');
        const tmr = document.getElementById('ad-timer'); const adType = btn.getAttribute('data-ad-type');
        btn.style.display = 'none'; tmr.style.display = 'block';
        const inter = setInterval(() => {
            tmr.innerText = sec; sec--;
            if(sec < 0) {
                clearInterval(inter);
                if(adType === 'hearts' || adType === 'manual') { gameState.hearts = MAX_HEARTS; gameState.lastHeartTime = Date.now(); }
                save(); updateUI(); closeAdModal();
                btn.style.display = 'block'; tmr.style.display = 'none';
            }
        }, 1000);
    }
    
    function triggerRewardedAd() { startAd(); }
    window.onload = init;
</script>
</body>
</html>
