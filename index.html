    async function startCat(gid, name) {
        gameState.currentCat = name;
        switchScreen('scr-map');
        try {
            const r = await fetch(CSV + "&gid=" + gid);
            const d = await r.text();
            gameState.questions = d.split(/\r?\n/).slice(1).map(row => {
                const c = row.split(',').map(x => x.trim().replace(/"/g, ''));
                return { q: c[0], opts: [c[1], c[2], c[3], c[4]], a: c[5] };
            }).filter(q => q.q);
            
            // بناء الخريطة لأول مرة
            renderMap(true); 
        } catch(e) { console.error("Error loading questions", e); }
    }

    function renderMap(isFirstLoad = false) {
        const cont = document.getElementById('map-cont');
        const progKey = `${gameState.lang}_${gameState.currentCat}`;
        const unlocked = gameState.progress[progKey] || 1;

        // إذا كانت الخريطة فارغة، نبنيها
        if (cont.innerHTML === '' || isFirstLoad) {
            cont.innerHTML = '';
            gameState.questions.forEach((_, i) => {
                const node = document.createElement('div');
                const levelNum = i + 1;
                node.className = `lvl-node`;
                node.innerText = levelNum;
                node.id = `lvl-${levelNum}`; // معرف ثابت لكل مستوى
                cont.appendChild(node);
            });
        }

        // تحديث حالة المستويات فقط بدون مسح المحتوى
        gameState.questions.forEach((_, i) => {
            const levelNum = i + 1;
            const node = document.getElementById(`lvl-${levelNum}`);
            if (node) {
                node.className = `lvl-node ${levelNum <= unlocked ? 'unlocked' : ''} ${levelNum === unlocked ? 'current' : ''}`;
                node.onclick = levelNum <= unlocked ? () => openQuiz(i) : null;
            }
        });

        // التمرير للمستوى الحالي فقط عند دخول التصنيف لأول مرة
        if (isFirstLoad) {
            setTimeout(() => {
                const current = document.querySelector('.lvl-node.current');
                if (current) {
                    current.scrollIntoView({ block: 'center' });
                }
            }, 50);
        }
    }
