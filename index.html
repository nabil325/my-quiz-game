<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="logo.png">
    <meta property="og:image" content="logo.png">
    <meta property="og:title" content="IQ Ø«Ù‚Ø§ÙØ© - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ©">
    <meta property="og:description" content="Ø§Ø®ØªØ¨Ø± Ø°ÙƒØ§Ø¡Ùƒ ÙˆÙ…Ø¹Ù„ÙˆÙ…Ø§ØªÙƒ Ø§Ù„Ø¹Ø§Ù…Ø© ÙÙŠ Ø±Ø­Ù„Ø© Ù…Ù…ØªØ¹Ø© Ø¹Ø¨Ø± Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª.">
    
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">

    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>
    
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3940256099942544" crossorigin="anonymous"></script>
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>IQ Ø«Ù‚Ø§ÙØ© - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ©</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&family=Poppins:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --gold: #ffd700;
            --blue: #0ea5e9;
            --green: #10b981;
            --red: #ff4d4d;
            --dark: #0f0f0f;
            --card: #1a1a2e;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            width: 100%;
            height: 100%;
            font-family: 'Cairo', sans-serif;
            background: #000;
            color: white;
            overflow: hidden;
        }

        /* ===== Ø§Ù„Ø®Ù„ÙÙŠØ§Øª ===== */
        body {
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            transition: background-image 1s ease-in-out;
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.35);
            z-index: 1;
            pointer-events: none;
        }

        /* ===== Ø±Ø³Ø§Ø¦Ù„ ØªØ­Ø°ÙŠØ± ===== */
        #offline-warning {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: var(--red);
            color: white;
            text-align: center;
            padding: 12px;
            font-size: 0.9rem;
            z-index: 10000;
            display: none;
            font-weight: bold;
        }

        /* ===== Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ ===== */
        .top-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            padding: 12px 15px;
            display: none;
            justify-content: space-between;
            align-items: center;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(15px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .top-right, .top-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .player-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255, 255, 255, 0.1);
            padding: 6px 12px;
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
        }

        .player-avatar {
            width: 28px;
            height: 28px;
            background: linear-gradient(135deg, var(--gold), #ffed4e);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: black;
            font-weight: 900;
            font-size: 0.75rem;
        }

        .stat-badge {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 900;
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .hearts-group {
            display: flex;
            align-items: center;
            gap: 6px;
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 77, 77, 0.5);
            padding: 4px 8px;
            border-radius: 20px;
        }

        .recharge-btn {
            background: linear-gradient(135deg, var(--red), #ff6b6b);
            color: white;
            border: none;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            cursor: pointer;
            font-weight: bold;
            transition: 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .recharge-btn:hover {
            transform: scale(1.1);
        }

        .exit-btn {
            position: fixed;
            top: 70px;
            right: 15px;
            background: linear-gradient(135deg, var(--gold), #ffed4e);
            color: black;
            border: none;
            width: 45px;
            height: 45px;
            border-radius: 12px;
            font-size: 1.5rem;
            font-weight: 900;
            cursor: pointer;
            z-index: 1001;
            display: none;
            align-items: center;
            justify-content: center;
            transition: 0.2s;
        }

        .exit-btn:hover {
            transform: scale(1.05);
        }

        .icon-btn {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.2);
            width: 36px;
            height: 36px;
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1rem;
            transition: 0.2s;
        }

        .icon-btn:hover {
            background: rgba(0, 0, 0, 0.6);
        }

        /* ===== Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø§Ø³Ù… ===== */
        .name-input-screen {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(15px);
            z-index: 5000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .name-box {
            background: var(--card);
            padding: 40px 30px;
            border-radius: 25px;
            border: 2px solid var(--gold);
            text-align: center;
            width: 85%;
            max-width: 400px;
        }

        .name-box h2 {
            color: var(--gold);
            margin-bottom: 10px;
        }

        .name-box input {
            width: 100%;
            padding: 12px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            margin: 20px 0;
            font-size: 1.1rem;
            text-align: center;
            background: rgba(255, 255, 255, 0.05);
            color: white;
            font-family: 'Cairo';
        }

        .name-box input:focus {
            outline: none;
            border-color: var(--gold);
        }

        /* ===== Ø§Ù„Ø´Ø§Ø´Ø§Øª ===== */
        .screen {
            position: relative;
            z-index: 10;
            height: 100vh;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 20px;
            box-sizing: border-box;
        }

        .screen.active {
            display: flex;
        }

        .fact-container {
            background: rgba(0, 0, 0, 0.6);
            padding: 25px;
            border-radius: 20px;
            margin: 20px;
            max-width: 420px;
            min-height: 130px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            overflow-y: auto;
        }

        .logo-wrapper {
            margin-bottom: 30px;
        }

        .main-logo {
            font-size: 4.5rem;
            font-weight: 900;
            margin: 0;
            background: linear-gradient(180deg, #fff 30%, var(--gold) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .logo-subtitle {
            font-size: 0.85rem;
            color: var(--gold);
            letter-spacing: 3px;
            font-weight: 700;
        }

        /* ===== Ø§Ù„Ø£Ø²Ø±Ø§Ø± ===== */
        .gold-btn {
            background: linear-gradient(135deg, var(--gold), #ffed4e);
            color: black;
            border: none;
            padding: 14px 70px;
            border-radius: 50px;
            font-size: 1.2rem;
            font-weight: 900;
            cursor: pointer;
            transition: 0.3s;
            font-family: 'Cairo';
        }

        .gold-btn:hover:not(:disabled) {
            transform: translateY(-2px);
        }

        .gold-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .glass-btn {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 900;
            font-family: 'Cairo';
        }

        .glass-btn:hover {
            background: rgba(0, 0, 0, 0.7);
        }

        /* ===== Ø§Ù„Ù„ØºØ§Øª ===== */
        .lang-toggle {
            margin-bottom: 25px;
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .lang-btn {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 8px 14px;
            border-radius: 15px;
            cursor: pointer;
            font-weight: 900;
            font-size: 0.9rem;
            transition: 0.2s;
        }

        .lang-btn.active {
            background: var(--blue);
            border-color: var(--blue);
        }

        /* ===== Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª ===== */
        .cat-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            width: 100%;
            max-width: 450px;
        }

        .cat-btn {
            background: rgba(0, 0, 0, 0.6);
            padding: 25px 10px;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            cursor: pointer;
            font-weight: 900;
            color: white;
            font-size: 1rem;
            transition: 0.3s;
        }

        .cat-btn:hover {
            background: rgba(0, 0, 0, 0.8);
            transform: translateY(-3px);
        }

        /* ===== Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª ===== */
        .map-view {
            width: 100%;
            height: 100vh;
            overflow-y: auto;
            padding: 150px 0;
            display: flex;
            flex-direction: column-reverse;
            align-items: center;
            gap: 40px;
        }

        .level-node {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.5);
            border: 3px solid rgba(255, 255, 255, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.6rem;
            font-weight: 900;
            cursor: default;
            transition: 0.3s;
            color: white;
            position: relative;
            flex-shrink: 0;
        }

        .level-node.completed {
            background: linear-gradient(135deg, var(--gold), #ffed4e);
            border-color: #b8860b;
            color: black;
            cursor: pointer;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.4);
        }

        .level-node.completed:hover {
            transform: scale(1.1);
        }

        .level-node.current {
            background: white;
            border-color: var(--gold);
            color: black;
            cursor: pointer;
            animation: pulse 2s infinite;
            z-index: 5;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.12); }
        }

        /* ===== Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± ===== */
        .quiz-container {
            position: fixed;
            bottom: -100%;
            left: 0;
            width: 100%;
            background: rgba(15, 15, 15, 0.98);
            backdrop-filter: blur(30px);
            border-radius: 35px 35px 0 0;
            border-top: 3px solid var(--gold);
            padding: 30px 20px;
            box-sizing: border-box;
            z-index: 2000;
            transition: 0.6s;
            max-height: 75vh;
            overflow-y: auto;
        }

        .quiz-container.show {
            bottom: 0;
        }

        .question-text {
            font-size: 1.3rem;
            font-weight: bold;
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .answers-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 20px;
        }

        .answer-btn {
            background: rgba(255, 255, 255, 0.08);
            padding: 16px;
            border-radius: 12px;
            cursor: pointer;
            border: 1px solid rgba(255, 255, 255, 0.15);
            font-weight: bold;
            text-align: center;
            color: white;
            transition: 0.2s;
            font-family: 'Cairo';
        }

        .answer-btn:hover:not(.wrong):not(.correct) {
            background: rgba(255, 255, 255, 0.15);
        }

        .answer-btn.wrong {
            background: #ef4444;
            animation: shake 0.3s;
        }

        .answer-btn.correct {
            background: var(--green);
            animation: wiggle 0.5s;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        @keyframes wiggle {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        /* ===== Ù„ÙˆØ­Ø© Ø§Ù„ØªØ±ØªÙŠØ¨ ===== */
        .leaderboard-modal {
            position: fixed;
            inset: 0;
            display: none;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.95);
            z-index: 6000;
        }

        .leaderboard-box {
            background: var(--card);
            padding: 25px;
            border-radius: 20px;
            width: 90%;
            max-width: 420px;
            border: 1px solid var(--gold);
            max-height: 70vh;
            overflow-y: auto;
        }

        .leader-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* ===== modal Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª ===== */
        .ad-modal {
            position: fixed;
            inset: 0;
            display: none;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.95);
            z-index: 4000;
        }

        .ad-box {
            background: var(--card);
            padding: 35px;
            border-radius: 20px;
            width: 85%;
            max-width: 420px;
            text-align: center;
            border: 2px solid var(--gold);
        }

        .ad-box h3 {
            color: var(--gold);
            font-size: 1.5rem;
            margin-bottom: 10px;
        }

        .ad-timer {
            font-size: 2.5rem;
            color: var(--gold);
            font-weight: bold;
            margin: 20px 0;
            display: none;
        }

        #regen-timer {
            font-size: 0.7rem;
            color: #fff;
            margin-left: 5px;
        }

        @media (max-width: 600px) {
            .main-logo {
                font-size: 3rem;
            }

            .answers-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body style="background-image: url('athena.jpg');">

<div id="offline-warning"></div>
<div class="overlay"></div>

<audio id="bg-audio" src="./jazz-music-466491.mp3" loop></audio>

<button id="exit-btn" onclick="goBack()" class="exit-btn">â”</button>

<div id="top-bar" class="top-bar">
    <div class="top-right">
        <div class="player-badge">
            <div class="player-avatar" id="avatar">?</div>
            <span id="player-name">...</span>
        </div>
        <div class="hearts-group">
            <span>â¤ï¸</span>
            <span id="hearts-count">5</span>
            <span id="regen-timer"></span>
            <button onclick="showAdModal('manual')" class="recharge-btn">+</button>
        </div>
        <div class="stat-badge" style="color: var(--gold);">
            ğŸ† <span id="score-count">0</span>
        </div>
    </div>
    <div class="top-left">
        <button id="mute-btn" class="icon-btn" onclick="toggleMute()">ğŸ”Š</button>
    </div>
</div>

<div id="name-screen" class="name-input-screen">
    <div class="name-box">
        <h2>Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ! ğŸ‘‹</h2>
        <p>Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ Ù„ØªØ¨Ø¯Ø£ Ø±Ø­Ù„Ø© Ø§Ù„Ø«Ù‚Ø§ÙØ©</p>
        <input type="text" id="name-input" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ..." maxlength="15" onkeypress="if(event.key==='Enter') submitName()">
        <button onclick="submitName()" class="gold-btn" style="padding: 12px 50px; margin-top: 20px;">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¢Ù†</button>
    </div>
</div>

<div id="screen-start" class="screen active">
    <div class="logo-wrapper">
        <h1 class="main-logo">IQ Ø«Ù‚Ø§ÙØ©</h1>
        <div class="logo-subtitle">Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ©</div>
    </div>
    <div class="fact-container">
        <p id="fact-text" style="font-size: 1.1rem; line-height: 1.6;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø­Ù‚ÙŠÙ‚Ø© Ù…Ù…ØªØ¹Ø©...</p>
    </div>
    <div style="display: flex; flex-direction: column; gap: 12px; margin-top: 20px;">
        <button onclick="showCategories()" class="gold-btn">Ø§Ø³ØªÙ…Ø±Ø§Ø± â†’</button>
        <button onclick="openLeaderboard()" class="glass-btn" style="color: var(--gold); font-size: 1rem;">ğŸ† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ†</button>
    </div>
</div>

<div id="screen-cats" class="screen">
    <h2 style="margin-bottom: 20px; font-size: 1.7rem;">Ø§Ø®ØªØ± Ø§Ù„ØªØµÙ†ÙŠÙ ğŸ“š</h2>
    <div class="lang-toggle">
        <button class="lang-btn active" onclick="changeLang('ar')">ğŸ‡¸ğŸ‡¦ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</button>
        <button class="lang-btn" onclick="changeLang('en')">ğŸ‡ºğŸ‡¸ English</button>
        <button class="lang-btn" onclick="changeLang('es')">ğŸ‡ªğŸ‡¸ EspaÃ±ol</button>
        <button class="lang-btn" onclick="changeLang('fr')">ğŸ‡«ğŸ‡· FranÃ§ais</button>
    </div>
    <div class="cat-grid" id="categories-container"></div>
</div>

<div id="screen-map" class="screen" style="padding: 0; justify-content: flex-start;">
    <div class="map-view" id="levels-map"></div>
</div>

<div id="leaderboard-modal" class="leaderboard-modal">
    <div class="leaderboard-box">
        <h2 style="color: var(--gold); margin-bottom: 20px;">Ø£ÙØ¶Ù„ 10 Ù„Ø§Ø¹Ø¨ÙŠÙ† ğŸ†</h2>
        <div id="leaderboard-content"></div>
        <button onclick="closeLeaderboard()" class="glass-btn" style="width: 100%; margin-top: 15px;">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
</div>

<div id="quiz-container" class="quiz-container">
    <div class="question-text" id="question"></div>
    <div class="answers-grid" id="answers-container"></div>
</div>

<div id="ad-modal" class="ad-modal">
    <div class="ad-box">
        <h3 id="ad-title">Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù‚Ù„ÙˆØ¨! â¤ï¸</h3>
        <p id="ad-description">Ø´Ø§Ù‡Ø¯ Ø¥Ø¹Ù„Ø§Ù† Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù‚Ù„ÙˆØ¨ ÙƒØ§Ù…Ù„Ø©</p>
        <div class="ad-timer" id="ad-timer">5</div>
        <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 20px;">
            <button onclick="watchAd()" class="gold-btn" style="padding: 12px;">ğŸ“º Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†</button>
            <button onclick="closeAdModal()" class="glass-btn">Ø±Ø¨Ù…Ø§ Ù„Ø§Ø­Ù‚Ø§Ù‹</button>
        </div>
    </div>
</div>

<script>
    // ============== Firebase Config ==============
    const firebaseConfig = {
        apiKey: "AIzaSyCIXq5egNrR0dS5YI2L4BFnm3IGa11128Q",
        databaseURL: "https://iq-culture-default-rtdb.firebaseio.com/",
        projectId: "iq-culture"
    };

    try {
        firebase.initializeApp(firebaseConfig);
    } catch(e) {
        console.log('Firebase');
    }
    const db = firebase.database();

    // ============== Ø«ÙˆØ§Ø¨Øª ==============
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSJ4RCU1_iXMqLS3ApB1g8SjSrL2hbIAv-1VniqdMElnalov--mSDTpe9rjMxaWGCuP6gpxWV7OZDe1/pub?output=csv";
    const MAX_HEARTS = 5;
    const REGEN_TIME = 5 * 60 * 1000; // 5 Ø¯Ù‚Ø§Ø¦Ù‚

    // ============== Ø§Ù„Ø®Ù„ÙÙŠØ§Øª ==============
    const CATEGORY_IMAGES = {
        history: 'history.jpg',
        geo: 'geography.jpg',
        science: 'science.jpg',
        general: 'general.jpg',
        sports: 'sports.jpg'
    };

    // ============== Ø­Ø§Ù„Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© ==============
    const gameState = {
        playerName: localStorage.getItem('iq_player_name') || "",
        score: parseInt(localStorage.getItem('iq_score')) || 0,
        progress: JSON.parse(localStorage.getItem('iq_progress') || '{}'),
        hearts: parseInt(localStorage.getItem('iq_hearts')) || MAX_HEARTS,
        lastHeartTime: parseInt(localStorage.getItem('iq_last_heart')) || Date.now(),
        muted: (localStorage.getItem('iq_muted') === 'true') || false,
        language: localStorage.getItem('iq_language') || 'ar',
        currentCategory: '',
        currentQuestion: 0,
        questions: [],
        heartRegenInterval: null
    };

    // ============== Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù„ØºØ§Øª ==============
    const languages = {
        ar: {
            factsId: "605574246",
            categories: [
                { name: "â³ Ø§Ù„ØªØ§Ø±ÙŠØ®", id: "11216236", key: "history" },
                { name: "ğŸŒ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠØ§", id: "99625756", key: "geo" },
                { name: "ğŸ§¬ Ø§Ù„Ø¹Ù„ÙˆÙ…", id: "1843208636", key: "science" },
                { name: "ğŸ’¡ Ø«Ù‚Ø§ÙØ© Ø¹Ø§Ù…Ø©", id: "564130158", key: "general" },
                { name: "âš½ Ø§Ù„Ø±ÙŠØ§Ø¶Ø©", id: "0", key: "sports" }
            ]
        },
        en: {
            factsId: "259198059",
            categories: [
                { name: "â³ History", id: "1950805065", key: "history" },
                { name: "ğŸŒ Geography", id: "1899297807", key: "geo" },
                { name: "ğŸ§¬ Science", id: "407039200", key: "science" },
                { name: "ğŸ’¡ General", id: "1044248022", key: "general" },
                { name: "âš½ Sports", id: "1559005659", key: "sports" }
            ]
        },
        es: {
            factsId: "1911794502",
            categories: [
                { name: "â³ Historia", id: "948777647", key: "history" },
                { name: "ğŸŒ GeografÃ­a", id: "1233201488", key: "geo" },
                { name: "ğŸ§¬ Ciencia", id: "2028449800", key: "science" },
                { name: "ğŸ’¡ Cultura General", id: "1662832315", key: "general" },
                { name: "âš½ Deportes", id: "1795176380", key: "sports" }
            ]
        },
        fr: {
            factsId: "1356278776",
            categories: [
                { name: "â³ Histoire", id: "1692460075", key: "history" },
                { name: "ğŸŒ GÃ©ographie", id: "1888258036", key: "geo" },
                { name: "ğŸ§¬ Sciences", id: "1043839601", key: "science" },
                { name: "ğŸ’¡ Culture GÃ©nÃ©rale", id: "1000789609", key: "general" },
                { name: "âš½ Sports", id: "942675202", key: "sports" }
            ]
        }
    };

    // ============== Ø§Ù„Ø¹Ù†Ø§ØµØ± ==============
    const elements = {
        audio: document.getElementById('bg-audio'),
        muteBtn: document.getElementById('mute-btn'),
        offlineWarning: document.getElementById('offline-warning'),
        nameScreen: document.getElementById('name-screen'),
        nameInput: document.getElementById('name-input'),
        avatar: document.getElementById('avatar'),
        playerName: document.getElementById('player-name'),
        hearts: document.getElementById('hearts-count'),
        regenTimer: document.getElementById('regen-timer'),
        score: document.getElementById('score-count'),
        topBar: document.getElementById('top-bar'),
        exitBtn: document.getElementById('exit-btn'),
        body: document.body
    };

    // ============== Ø§Ù„ØªÙ‡ÙŠØ¦Ø© ==============
    function init() {
        console.log('Game Starting...');
        checkConnection();
        checkPlayerName();
        loadFact();
        renderCategories();
        updateDisplay();
        startHeartRegen(); // Ø¨Ø¯Ø¡ Ù†Ø¸Ø§Ù… ØªØ¬Ø¯ÙŠØ¯ Ø§Ù„Ù‚Ù„ÙˆØ¨
        window.addEventListener('online', checkConnection);
        window.addEventListener('offline', checkConnection);
    }

    // ============== ÙØ­Øµ Ø§Ù„Ø§ØªØµØ§Ù„ ==============
    function checkConnection() {
        const warning = elements.offlineWarning;
        if (!navigator.onLine) {
            warning.innerText = "âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª";
            warning.style.display = 'block';
        } else {
            warning.style.display = 'none';
        }
    }

    // ============== Ù†Ø¸Ø§Ù… ØªØ¬Ø¯ÙŠØ¯ Ø§Ù„Ù‚Ù„ÙˆØ¨ ===== */
    function startHeartRegen() {
        // Ø­Ø°Ù Ø§Ù„Ù€ interval Ø§Ù„Ø³Ø§Ø¨Ù‚ Ø¥Ù† ÙˆØ¬Ø¯
        if (gameState.heartRegenInterval) {
            clearInterval(gameState.heartRegenInterval);
        }

        // ØªØ­Ø¯ÙŠØ« ÙƒÙ„ Ø«Ø§Ù†ÙŠØ© Ù„Ù„Ø¹Ø±Ø¶
        gameState.heartRegenInterval = setInterval(() => {
            if (gameState.hearts >= MAX_HEARTS) {
                elements.regenTimer.innerText = '';
                return;
            }

            const now = Date.now();
            const elapsed = now - gameState.lastHeartTime;
            const remaining = REGEN_TIME - elapsed;

            if (remaining <= 0) {
                // Ø¥Ø¶Ø§ÙØ© Ù‚Ù„Ø¨ Ø¬Ø¯ÙŠØ¯
                gameState.hearts++;
                gameState.lastHeartTime = now;
                saveGame();
                updateDisplay();

                // Ø¥Ø°Ø§ ÙˆØµÙ„Ù†Ø§ Ù„Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰
                if (gameState.hearts >= MAX_HEARTS) {
                    elements.regenTimer.innerText = '';
                    return;
                }
            }

            // Ø­Ø³Ø§Ø¨ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ
            const remainingSeconds = Math.ceil(remaining / 1000);
            const minutes = Math.floor(remainingSeconds / 60);
            const seconds = remainingSeconds % 60;

            elements.regenTimer.innerText = `â±ï¸ ${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
        }, 1000);
    }

    // ============== Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨ ==============
    function checkPlayerName() {
        if (!gameState.playerName) {
            elements.nameScreen.style.display = 'flex';
        } else {
            updatePlayerDisplay();
        }
    }

    function submitName() {
        const name = elements.nameInput.value.trim();
        if (name.length < 2) {
            alert('Ø§Ø³Ù… Ù‚ØµÙŠØ± Ø¬Ø¯Ø§Ù‹!');
            return;
        }
        gameState.playerName = name.substring(0, 15);
        localStorage.setItem('iq_player_name', gameState.playerName);
        elements.nameScreen.style.display = 'none';
        updatePlayerDisplay();
        saveGame();
    }

    function updatePlayerDisplay() {
        const name = gameState.playerName || "Player";
        elements.playerName.innerText = name;
        elements.avatar.innerText = name.charAt(0).toUpperCase();
    }

    // ============== Ø§Ù„Ø­Ù‚Ø§Ø¦Ù‚ ==============
    function loadFact() {
        const factEl = document.getElementById('fact-text');
        const lang = languages[gameState.language];

        fetch(CSV_URL + "&gid=" + lang.factsId)
            .then(r => r.text())
            .then(data => {
                const lines = data.split('\n').slice(1).filter(l => l.trim());
                if (lines.length) {
                    const fact = lines[Math.floor(Math.random() * lines.length)]
                        .split(',')[0]
                        .replace(/"/g, '');
                    factEl.innerText = fact || 'Ø­Ù‚ÙŠÙ‚Ø© Ù…Ù…ØªØ¹Ø©!';
                }
            })
            .catch(e => {
                console.error(e);
                factEl.innerText = 'ğŸ’¡ Ù‡Ù„ ØªØ¹Ø±Ù Ø£Ù† Ø§Ù„Ù„Ø¹Ø¨Ø© Ù…Ø°Ù‡Ù„Ø©ØŸ';
            });
    }

    // ============== Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª ==============
    function renderCategories() {
        const container = document.getElementById('categories-container');
        const lang = languages[gameState.language];
        container.innerHTML = '';

        lang.categories.forEach(cat => {
            const btn = document.createElement('div');
            btn.className = 'cat-btn';
            if (cat.key === 'sports') btn.style.gridColumn = 'span 2';
            btn.innerText = cat.name;
            btn.onclick = () => startCategory(cat.id, cat.key);
            container.appendChild(btn);
        });
    }

    // ============== Ø§Ù„ØªÙ†Ù‚Ù„ Ø¨ÙŠÙ† Ø§Ù„Ø´Ø§Ø´Ø§Øª ==============
    function switchScreen(screenId) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(screenId).classList.add('active');
    }

    function showCategories() {
        elements.topBar.style.display = 'flex';
        elements.exitBtn.style.display = 'flex';
        // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
        elements.body.style.backgroundImage = "url('athena.jpg')";
        if (!gameState.muted) elements.audio.play().catch(() => {});
        switchScreen('screen-cats');
    }

    function goBack() {
        const quiz = document.getElementById('quiz-container');
        if (quiz.classList.contains('show')) {
            quiz.classList.remove('show');
            return;
        }

        const mapScreen = document.getElementById('screen-map');
        const catsScreen = document.getElementById('screen-cats');

        if (mapScreen.classList.contains('active')) {
            elements.body.style.backgroundImage = "url('athena.jpg')";
            switchScreen('screen-cats');
        } else if (catsScreen.classList.contains('active')) {
            switchScreen('screen-start');
            elements.topBar.style.display = 'none';
            elements.exitBtn.style.display = 'none';
        }
    }

    // ============== Ø¨Ø¯Ø¡ Ø§Ù„ØªØµÙ†ÙŠÙ ==============
    async function startCategory(catId, catKey) {
        if (!navigator.onLine) {
            alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§ØªØµØ§Ù„!');
            return;
        }

        gameState.currentCategory = catKey;
        // === ØªØºÙŠÙŠØ± Ø§Ù„Ø®Ù„ÙÙŠØ© ===
        elements.body.style.backgroundImage = `url('${CATEGORY_IMAGES[catKey]}')`;
        switchScreen('screen-map');

        try {
            const response = await fetch(CSV_URL + "&gid=" + catId);
            const data = await response.text();
            gameState.questions = data
                .split('\n')
                .slice(1)
                .filter(line => line.trim())
                .map(line => {
                    const parts = line.split(',').map(p => p.trim().replace(/"/g, ''));
                    return {
                        question: parts[0],
                        answers: [parts[1], parts[2], parts[3], parts[4]],
                        correct: parts[5]
                    };
                });

            renderMap();
        } catch (error) {
            console.error(error);
            alert('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©');
        }
    }

    // ============== Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª ==============
    function renderMap() {
        const container = document.getElementById('levels-map');
        const progKey = `${gameState.language}_${gameState.currentCategory}`;
        const completed = gameState.progress[progKey] || 0;

        container.innerHTML = '';

        gameState.questions.forEach((_, idx) => {
            const level = idx + 1;
            const node = document.createElement('div');
            node.className = 'level-node';
            node.innerText = level;
            node.style.transform = `translateX(${(idx % 2 === 0) ? '40px' : '-40px'})`;

            if (level <= completed) {
                node.classList.add('completed');
                node.onclick = () => openQuestion(idx);
            } else if (level === completed + 1) {
                node.classList.add('current');
                node.onclick = () => openQuestion(idx);
            }

            container.appendChild(node);
        });

        const firstCurrent = container.querySelector('.current');
        if (firstCurrent) {
            setTimeout(() => {
                firstCurrent.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 100);
        }
    }

    // ============== ÙØªØ­ Ø§Ù„Ø³Ø¤Ø§Ù„ ==============
    function openQuestion(qIdx) {
        if (gameState.hearts <= 0) {
            showAdModal('hearts');
            return;
        }

        gameState.currentQuestion = qIdx;
        const q = gameState.questions[qIdx];

        document.getElementById('question').innerText = q.question;
        const container = document.getElementById('answers-container');
        container.innerHTML = '';

        let answers = q.answers.map((ans, idx) => ({
            text: ans,
            correctLetter: String.fromCharCode(97 + idx)
        }));

        answers.sort(() => Math.random() - 0.5);

        answers.forEach(ans => {
            const btn = document.createElement('div');
            btn.className = 'answer-btn';
            btn.innerText = ans.text;
            btn.onclick = () => checkAnswer(btn, ans.correctLetter, q.correct.toLowerCase());
            container.appendChild(btn);
        });

        document.getElementById('quiz-container').classList.add('show');
    }

    // ============== Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© ==============
    function checkAnswer(btn, selected, correct) {
        const progKey = `${gameState.language}_${gameState.currentCategory}`;

        if (selected === correct.charAt(0)) {
            btn.classList.add('correct');
            gameState.score += 10;

            const currentLevel = (gameState.progress[progKey] || 0) + 1;
            if (gameState.currentQuestion + 1 === currentLevel) {
                gameState.progress[progKey] = currentLevel;
            }

            saveGame();
            updateDisplay();

            setTimeout(() => {
                document.getElementById('quiz-container').classList.remove('show');
                renderMap();
            }, 800);
        } else {
            btn.classList.add('wrong');
            gameState.hearts--;

            if (gameState.hearts <= 0) {
                saveGame();
                updateDisplay();
                setTimeout(() => {
                    document.getElementById('quiz-container').classList.remove('show');
                    showAdModal('hearts');
                }, 800);
            } else {
                saveGame();
                updateDisplay();
                setTimeout(() => {
                    document.getElementById('quiz-container').classList.remove('show');
                }, 800);
            }
        }
    }

    // ============== Ø§Ù„ØµÙˆØª ==============
    function toggleMute() {
        gameState.muted = !gameState.muted;
        if (gameState.muted) {
            elements.audio.pause();
        } else {
            elements.audio.play().catch(() => {});
        }
        elements.muteBtn.innerText = gameState.muted ? 'ğŸ”‡' : 'ğŸ”Š';
        saveGame();
    }

    // ============== Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª ==============
    function showAdModal(type) {
        const modal = document.getElementById('ad-modal');
        const title = document.getElementById('ad-title');
        const desc = document.getElementById('ad-description');

        if (type === 'hearts') {
            title.innerText = 'Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù‚Ù„ÙˆØ¨! â¤ï¸';
            desc.innerText = 'Ø´Ø§Ù‡Ø¯ Ø¥Ø¹Ù„Ø§Ù† Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù‚Ù„ÙˆØ¨ Ø¬Ø¯ÙŠØ¯Ø©';
        } else {
            title.innerText = 'Ø´Ø­Ù† Ø§Ù„Ù‚Ù„ÙˆØ¨';
            desc.innerText = 'Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ 5 Ù‚Ù„ÙˆØ¨ Ù…Ø¬Ø§Ù†ÙŠØ©';
        }

        modal.style.display = 'flex';
    }

    function closeAdModal() {
        document.getElementById('ad-modal').style.display = 'none';
    }

    function watchAd() {
        let count = 3;
        const timer = document.getElementById('ad-timer');
        const btn = document.querySelector('#ad-modal .gold-btn');

        btn.style.display = 'none';
        timer.style.display = 'block';

        const interval = setInterval(() => {
            timer.innerText = count;
            count--;

            if (count < 0) {
                clearInterval(interval);
                gameState.hearts = MAX_HEARTS;
                gameState.lastHeartTime = Date.now();
                saveGame();
                updateDisplay();
                closeAdModal();
                btn.style.display = 'block';
                timer.style.display = 'none';
                startHeartRegen(); // Ø¥Ø¹Ø§Ø¯Ø© Ø¨Ø¯Ø¡ Ø§Ù„Ø¹Ø¯Ø§Ø¯
            }
        }, 1000);
    }

    // ============== Ù„ÙˆØ­Ø© Ø§Ù„ØªØ±ØªÙŠØ¨ ==============
    function openLeaderboard() {
        const modal = document.getElementById('leaderboard-modal');
        const content = document.getElementById('leaderboard-content');
        modal.style.display = 'flex';
        content.innerHTML = '<p>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>';

        db.ref('leaderboard')
            .orderByChild('score')
            .limitToLast(10)
            .once('value', snapshot => {
                const leaders = [];
                snapshot.forEach(child => leaders.push(child.val()));
                leaders.reverse();

                content.innerHTML = '';
                leaders.forEach((leader, idx) => {
                    const rank = idx === 0 ? 'ğŸ¥‡' : idx === 1 ? 'ğŸ¥ˆ' : idx === 2 ? 'ğŸ¥‰' : (idx + 1);
                    const item = document.createElement('div');
                    item.className = 'leader-item';
                    item.innerHTML = `
                        <div>
                            <span style="font-weight: 900; font-size: 1.1rem; margin-right: 10px;">${rank}</span>
                            <span>${leader.name}</span>
                        </div>
                        <span style="color: var(--gold); font-weight: 900;">${leader.score}</span>
                    `;
                    content.appendChild(item);
                });
            })
            .catch(e => {
                content.innerHTML = '<p style="color: red;">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„</p>';
            });
    }

    function closeLeaderboard() {
        document.getElementById('leaderboard-modal').style.display = 'none';
    }

    // ============== Ø§Ù„Ù„ØºØ§Øª ==============
    function changeLang(lang) {
        gameState.language = lang;
        localStorage.setItem('iq_language', lang);

        document.querySelectorAll('.lang-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');

        loadFact();
        renderCategories();
    }

    // ============== Ø§Ù„Ø­ÙØ¸ ==============
    function saveGame() {
        localStorage.setItem('iq_score', gameState.score);
        localStorage.setItem('iq_progress', JSON.stringify(gameState.progress));
        localStorage.setItem('iq_hearts', gameState.hearts);
        localStorage.setItem('iq_last_heart', gameState.lastHeartTime);
        localStorage.setItem('iq_muted', gameState.muted);

        if (gameState.playerName) {
            db.ref('leaderboard/' + gameState.playerName).set({
                name: gameState.playerName,
                score: gameState.score
            }).catch(e => console.error(e));
        }
    }

    function updateDisplay() {
        elements.score.innerText = gameState.score;
        elements.hearts.innerText = gameState.hearts;
        elements.muteBtn.innerText = gameState.muted ? 'ğŸ”‡' : 'ğŸ”Š';
        updatePlayerDisplay();
    }

    // ============== Ø§Ù„Ø¨Ø¯Ø¡ ==============
    window.addEventListener('DOMContentLoaded', init);
</script>

</body>
</html>
