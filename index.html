<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IQ Ø«Ù‚Ø§ÙØ© - Ù†Ø¸Ø§Ù… ØªØ­Ø¯ÙŠ Ø§Ù„Ù‚Ù„ÙˆØ¨</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&family=Poppins:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --gold: #ffd700;
            --blue: #0ea5e9;
            --glass: rgba(255, 255, 255, 0.1);
            --dark-glass: rgba(0, 0, 0, 0.7);
        }

        body, html {
            margin: 0; padding: 0; height: 100%; width: 100%;
            font-family: 'Cairo', sans-serif; color: white;
            overflow: hidden;
            background: #1a1a1a url('Warface Wallpaper.jpeg') no-repeat center center;
            background-size: cover;
            background-attachment: fixed;
        }

        .overlay {
            position: fixed; inset: 0;
            background: rgba(0, 0, 0, 0.55);
            z-index: 1;
        }

        .top-bar {
            position: fixed; top: 0; width: 100%; padding: 10px 15px;
            display: none; justify-content: space-between; align-items: center; z-index: 1000;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(10px);
            box-sizing: border-box; border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .top-left, .top-right { display: flex; gap: 12px; align-items: center; }

        .icon-btn {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            padding: 8px 12px; border-radius: 12px; cursor: pointer; 
            font-weight: 700; color: white; transition: 0.2s;
        }

        .screen {
            position: relative; z-index: 10; height: 100vh;
            display: none; flex-direction: column; align-items: center; justify-content: center;
            text-align: center; padding: 20px; box-sizing: border-box;
        }
        .active { display: flex; }

        .lang-toggle-container {
            margin-bottom: 25px;
            display: flex;
            justify-content: center;
            gap: 10px;
        }
        .lang-btn {
            background: var(--glass);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            padding: 10px 25px;
            border-radius: 15px;
            cursor: pointer;
            font-weight: 900;
            transition: 0.3s;
            backdrop-filter: blur(5px);
        }
        .lang-btn.active-lang {
            background: var(--blue);
            border-color: var(--blue);
            box-shadow: 0 0 15px rgba(14, 165, 233, 0.4);
        }

        .cat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 100%; max-width: 450px; }
        .cat-btn {
            background: var(--glass); backdrop-filter: blur(15px);
            padding: 25px 10px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.1);
            cursor: pointer; font-weight: 900; transition: 0.3s; color: white; font-size: 1.1rem;
        }
        .cat-btn:hover { background: var(--blue); transform: translateY(-3px); }

        .map-view { 
            width: 100%; overflow-y: auto; padding: 120px 0; 
            display: flex; flex-direction: column-reverse; align-items: center; gap: 35px; 
        }
        .lvl-node {
            width: 75px; height: 75px; border-radius: 50%;
            background: rgba(0,0,0,0.7); border: 4px solid #444;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.6rem; font-weight: 900; cursor: pointer; transition: 0.4s; color: white;
            position: relative;
        }
        .unlocked { border-color: var(--blue); background: rgba(14, 165, 233, 0.3); }
        .current { border-color: var(--gold); background: var(--gold); color: black; animation: pulse 2s infinite; }

        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); box-shadow: 0 0 25px var(--gold); } }

        .quiz-container {
            position: fixed; bottom: -100%; left: 0; width: 100%;
            background: rgba(15, 15, 15, 0.98); backdrop-filter: blur(30px);
            border-radius: 35px 35px 0 0; border-top: 3px solid var(--gold);
            padding: 30px 20px; box-sizing: border-box; z-index: 2000;
            transition: 0.6s cubic-bezier(0.19, 1, 0.22, 1);
            max-height: 75vh; overflow-y: auto;
        }
        .quiz-container.show { bottom: 0; }

        .ans-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 25px; }
        .ans-btn { 
            background: rgba(255,255,255,0.07); padding: 18px; border-radius: 15px; 
            cursor: pointer; border: 1px solid rgba(255,255,255,0.1); 
            font-weight: bold; text-align: center; color: white; transition: 0.2s;
        }
        .ans-btn.removed { visibility: hidden; pointer-events: none; }
        .ans-btn.wrong { background: #ef4444 !important; border-color: #ef4444; animation: shake 0.4s; }
        .ans-btn.correct { background: #10b981 !important; border-color: #10b981; }
        .disabled { opacity: 0.6; pointer-events: none; }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .gold-btn { background: var(--gold); border: none; padding: 15px 30px; border-radius: 12px; font-weight: 900; cursor: pointer; color: black; transition: 0.3s; }
        .gold-btn:active { transform: scale(0.95); }
        .glass-btn { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); padding: 12px 15px; border-radius: 12px; cursor: pointer; color: white; }

        .ad-modal {
            position: fixed; inset: 0; display: none; align-items: center; justify-content: center;
            background: rgba(0,0,0,0.9); z-index: 3000;
        }
        .ad-box {
            background: #222; padding: 35px; border-radius: 25px; width: 85%; max-width: 400px; 
            text-align: center; border: 2px solid var(--gold);
        }

        .hearts-txt { display: inline-flex; gap: 6px; align-items: center; font-weight: 900; color: #ff4d4d; }
    </style>
</head>
<body>

<audio id="bg-audio" src="./jazz-music-466491.mp3" loop></audio>
<div class="overlay"></div>

<div id="top-bar" class="top-bar">
    <div class="top-left">
        <div>ğŸ† <span id="score-val">0</span></div>
        <div class="hearts-txt">â¤ï¸ <span id="hearts-val">8</span></div>
    </div>
    <div class="top-right">
        <button onclick="showAdModal()" class="icon-btn" id="txt-recharge">ğŸ“º Ø´Ø­Ù†</button>
        <button id="mute-btn" class="icon-btn">ğŸ”Š</button>
        <button onclick="location.reload()" class="icon-btn">ğŸ </button>
    </div>
</div>

<div id="scr-start" class="screen active">
    <h1 id="main-logo" style="font-size: 4rem; color: var(--gold); font-weight: 900; margin-bottom: 5px;">IQ Ø«Ù‚Ø§ÙØ©</h1>
    <div style="background: var(--glass); padding: 25px; border-radius: 25px; margin: 20px; max-width: 400px; border: 1px solid rgba(255,255,255,0.1);">
        <p id="fact-txt" style="font-size: 1.1rem; line-height: 1.6;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ù…Ø¹Ù„ÙˆÙ…Ø© Ø§Ù„ÙŠÙˆÙ…...</p>
    </div>
    <button id="btn-start" onclick="showCats()" class="gold-btn" style="padding: 20px 100px; border-radius: 60px; font-size: 1.4rem;">Ø§Ø³ØªÙ…Ø±Ø§Ø±</button>
</div>

<div id="scr-cats" class="screen">
    <h2 id="txt-select-cat" style="margin-bottom: 20px; font-size: 2rem;">Ø§Ø®ØªØ± Ø§Ù„ØªØµÙ†ÙŠÙ</h2>
    
    <div class="lang-toggle-container">
        <button id="btn-lang-ar" class="lang-btn" onclick="setLanguage('ar')">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© ğŸ‡¸ğŸ‡¦</button>
        <button id="btn-lang-en" class="lang-btn" onclick="setLanguage('en')">English ğŸ‡ºğŸ‡¸</button>
    </div>

    <div class="cat-grid" id="cat-grid-container"></div>
</div>

<div id="scr-map" class="screen" style="padding:0; justify-content: flex-start;">
    <div class="map-view" id="map-cont"></div>
</div>

<div class="quiz-container" id="quiz-ui">
    <div id="q-text" style="font-size: 1.4rem; font-weight: bold; line-height: 1.5;"></div>
    <div class="ans-grid" id="ans-box"></div>
    <div class="controls-row" style="margin-top:25px; display:flex; justify-content:center;">
        <button id="remove-two-btn" class="glass-btn">Ø­Ø°Ù Ø®ÙŠØ§Ø±ÙŠÙ† (50 Ù†Ù‚Ø·Ø©)</button>
    </div>
</div>

<div class="ad-modal" id="ad-modal">
    <div class="ad-box">
        <h3 id="txt-no-hearts" style="color:var(--gold); font-size: 1.5rem;">Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù‚Ù„ÙˆØ¨!</h3>
        <p id="txt-ad-desc">Ø´Ø§Ù‡Ø¯ Ø¥Ø¹Ù„Ø§Ù† Ù‚ØµÙŠØ± Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ 8 Ù‚Ù„ÙˆØ¨ Ø¬Ø¯ÙŠØ¯Ø© ÙˆÙ…ÙˆØ§ØµÙ„Ø© Ø§Ù„Ù„Ø¹Ø¨.</p>
        <div id="ad-timer" style="display:none; font-size: 2rem; color: var(--gold); font-weight: bold; margin: 15px 0;">5</div>
        <div style="margin-top:25px; display: flex; flex-direction: column; gap: 10px;">
            <button id="watch-ad-btn" class="gold-btn">Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†</button>
            <button onclick="closeAdModal()" class="glass-btn" id="txt-later">Ø±Ø¨Ù…Ø§ Ù„Ø§Ø­Ù‚Ø§Ù‹</button>
        </div>
    </div>
</div>

<script>
    const CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSJ4RCU1_iXMqLS3ApB1g8SjSrL2hbIAv-1VniqdMElnalov--mSDTpe9rjMxaWGCuP6gpxWV7OZDe1/pub?output=csv";

    const langConfig = {
        ar: {
            dir: "rtl", font: "'Cairo', sans-serif", logo: "IQ Ø«Ù‚Ø§ÙØ©", start: "Ø§Ø³ØªÙ…Ø±Ø§Ø±", select: "Ø§Ø®ØªØ± Ø§Ù„ØªØµÙ†ÙŠÙ",
            recharge: "ğŸ“º Ø´Ø­Ù†", noHearts: "Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù‚Ù„ÙˆØ¨!", adDesc: "Ø´Ø§Ù‡Ø¯ Ø¥Ø¹Ù„Ø§Ù† Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù‚Ù„ÙˆØ¨.", later: "Ø±Ø¨Ù…Ø§ Ù„Ø§Ø­Ù‚Ø§Ù‹",
            removeBtn: "Ø­Ø°Ù Ø®ÙŠØ§Ø±ÙŠÙ† (50 Ù†Ù‚Ø·Ø©)", factLoading: "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...",
            factsGid: "605574246",
            cats: [
                { name: "â³ Ø§Ù„ØªØ§Ø±ÙŠØ®", gid: "11216236", key: "history" },
                { name: "ğŸŒ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠØ§", gid: "99625756", key: "geo" },
                { name: "ğŸ§¬ Ø§Ù„Ø¹Ù„ÙˆÙ…", gid: "1843208636", key: "science" },
                { name: "ğŸ’¡ Ø«Ù‚Ø§ÙØ© Ø¹Ø§Ù…Ø©", gid: "564130158", key: "general" },
                { name: "âš½ Ø§Ù„Ø±ÙŠØ§Ø¶Ø©", gid: "0", key: "sports" }
            ]
        },
        en: {
            dir: "ltr", font: "'Poppins', sans-serif", logo: "IQ Culture", start: "Continue", select: "Select Category",
            recharge: "ğŸ“º Refill", noHearts: "No Hearts!", adDesc: "Watch ad to get 8 hearts.", later: "Maybe later",
            removeBtn: "Remove 2 (50 pts)", factLoading: "Loading fact...",
            factsGid: "259198059",
            cats: [
                { name: "â³ History", gid: "1950805065", key: "history" },
                { name: "ğŸŒ Geography", gid: "1899297807", key: "geo" },
                { name: "ğŸ§¬ Science", gid: "407039200", key: "science" },
                { name: "ğŸ’¡ General", gid: "1044248022", key: "general" },
                { name: "âš½ Sports", gid: "1559005659", key: "sports" }
            ]
        }
    };

    let gameState = {
        score: parseInt(localStorage.getItem('iq_score')) || 0,
        progress: JSON.parse(localStorage.getItem('iq_prog')) || {}, 
        currentCat: '',
        questions: [],
        activeIdx: 0,
        hearts: parseInt(localStorage.getItem('iq_hearts')) || 8,
        muted: (localStorage.getItem('iq_muted') === 'true') || false,
        usedRemove: JSON.parse(localStorage.getItem('iq_rem_used') || '{}'),
        lang: localStorage.getItem('iq_lang') || 'ar'
    };

    const audioEl = document.getElementById('bg-audio');
    const muteBtn = document.getElementById('mute-btn');

    function init() {
        applyLanguage();
        updateUI();
        muteBtn.onclick = toggleMute;
        document.getElementById('remove-two-btn').onclick = useRemoveTwo;
        document.getElementById('watch-ad-btn').onclick = startAd;
    }

    function setLanguage(l) {
        gameState.lang = l;
        localStorage.setItem('iq_lang', l);
        applyLanguage();
    }

    function applyLanguage() {
        const conf = langConfig[gameState.lang];
        document.documentElement.dir = conf.dir;
        document.documentElement.lang = gameState.lang;
        document.body.style.fontFamily = conf.font;
        document.getElementById('main-logo').innerText = conf.logo;
        document.getElementById('btn-start').innerText = conf.start;
        document.getElementById('txt-select-cat').innerText = conf.select;
        document.getElementById('txt-recharge').innerText = conf.recharge;
        document.getElementById('txt-no-hearts').innerText = conf.noHearts;
        document.getElementById('txt-ad-desc').innerText = conf.adDesc;
        document.getElementById('txt-later').innerText = conf.later;
        document.getElementById('remove-two-btn').innerText = conf.removeBtn;
        document.getElementById('btn-lang-ar').className = `lang-btn ${gameState.lang==='ar'?'active-lang':''}`;
        document.getElementById('btn-lang-en').className = `lang-btn ${gameState.lang==='en'?'active-lang':''}`;
        loadFact();
        renderCats();
    }

    function loadFact() {
        const conf = langConfig[gameState.lang];
        document.getElementById('fact-txt').innerText = conf.factLoading;
        fetch(CSV + "&gid=" + conf.factsGid).then(r => r.text()).then(d => {
            const lines = d.split('\n').slice(1);
            if (lines.length) {
                const fact = lines[Math.floor(Math.random()*lines.length)].split(',')[0].replace(/"/g, '');
                document.getElementById('fact-txt').innerText = fact;
            }
        }).catch(() => document.getElementById('fact-txt').innerText = "...");
    }

    function renderCats() {
        const container = document.getElementById('cat-grid-container');
        container.innerHTML = '';
        langConfig[gameState.lang].cats.forEach(c => {
            const btn = document.createElement('div');
            btn.className = 'cat-btn';
            if(c.key === 'sports') btn.style.gridColumn = 'span 2';
            btn.innerText = c.name;
            btn.onclick = () => startCat(c.gid, c.key);
            container.appendChild(btn);
        });
    }

    function save() {
        localStorage.setItem('iq_score', gameState.score);
        localStorage.setItem('iq_prog', JSON.stringify(gameState.progress));
        localStorage.setItem('iq_hearts', gameState.hearts);
        localStorage.setItem('iq_muted', gameState.muted);
        localStorage.setItem('iq_rem_used', JSON.stringify(gameState.usedRemove));
    }

    function updateUI() {
        document.getElementById('score-val').innerText = gameState.score;
        document.getElementById('hearts-val').innerText = gameState.hearts;
        muteBtn.innerText = gameState.muted ? 'ğŸ”‡' : 'ğŸ”Š';
    }

    function toggleMute() {
        gameState.muted = !gameState.muted;
        gameState.muted ? audioEl.pause() : audioEl.play();
        save(); updateUI();
    }

    function showCats() {
        document.getElementById('top-bar').style.display = 'flex';
        if(!gameState.muted) audioEl.play().catch(()=>{});
        switchScreen('scr-cats');
    }

    function switchScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }

    async function startCat(gid, name) {
        gameState.currentCat = name;
        switchScreen('scr-map');
        const r = await fetch(CSV + "&gid=" + gid);
        const d = await r.text();
        gameState.questions = d.split('\n').slice(1).map(row => {
            const c = row.split(',').map(x => x.trim().replace(/"/g, ''));
            return { q: c[0], opts: [c[1], c[2], c[3], c[4]], a: c[5] };
        }).filter(q => q.q);
        renderMap();
    }

    function renderMap() {
        const cont = document.getElementById('map-cont');
        cont.innerHTML = '';
        const progKey = `${gameState.lang}_${gameState.currentCat}`;
        const unlocked = gameState.progress[progKey] || 1;
        gameState.questions.forEach((_, i) => {
            const node = document.createElement('div');
            node.className = `lvl-node ${i+1 <= unlocked ? 'unlocked' : ''} ${i+1 === unlocked ? 'current' : ''}`;
            node.innerText = i + 1;
            if (i+1 <= unlocked) node.onclick = () => openQuiz(i);
            cont.appendChild(node);
        });
    }

    function openQuiz(idx) {
        if(gameState.hearts <= 0) { showAdModal(); return; }
        gameState.activeIdx = idx;
        const q = gameState.questions[idx];
        document.getElementById('q-text').innerText = q.q;
        const box = document.getElementById('ans-box');
        box.innerHTML = '';
        const usedKey = `${gameState.lang}_${gameState.currentCat}_${idx}`;
        document.getElementById('remove-two-btn').style.display = (gameState.score >= 50 && !gameState.usedRemove[usedKey]) ? 'block' : 'none';
        q.opts.forEach(o => {
            const b = document.createElement('div');
            b.className = 'ans-btn';
            b.innerText = o;
            b.onclick = () => checkAns(b, o, q.a);
            box.appendChild(b);
        });
        document.getElementById('quiz-ui').classList.add('show');
    }

    // Ø§Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¬Ø¯ÙŠØ¯: Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø®Ø·Ø£ ÙˆØ®Ø³Ø§Ø±Ø© Ù‚Ù„Ø¨
    function checkAns(btn, sel, cor) {
        const progKey = `${gameState.lang}_${gameState.currentCat}`;
        
        if(sel === cor) {
            // Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©: Ù†ØºÙ„Ù‚ Ø§Ù„Ø³Ø¤Ø§Ù„ ÙˆÙ†Ù†ØªÙ‚Ù„
            document.querySelectorAll('.ans-btn').forEach(b => b.classList.add('disabled'));
            btn.classList.add('correct');
            gameState.score += 10;
            if(gameState.activeIdx + 1 === (gameState.progress[progKey] || 1)) {
                gameState.progress[progKey] = (gameState.progress[progKey] || 1) + 1;
            }
            save(); updateUI();
            setTimeout(() => {
                document.getElementById('quiz-ui').classList.remove('show');
                renderMap();
            }, 1000);
        } else {
            // Ø¥Ø¬Ø§Ø¨Ø© Ø®Ø§Ø·Ø¦Ø©: ÙŠØ®Ø³Ø± Ù‚Ù„Ø¨ ÙˆÙŠÙ…ÙƒÙ†Ù‡ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ ÙÙˆØ±Ø§Ù‹
            btn.classList.add('wrong');
            btn.classList.add('disabled'); // ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø²Ø± Ø§Ù„Ø®Ø§Ø·Ø¦ ÙÙ‚Ø·
            gameState.hearts--;
            save(); updateUI();
            
            // Ø¥Ø°Ø§ Ù†ÙØ¯Øª Ø§Ù„Ù‚Ù„ÙˆØ¨ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©
            if(gameState.hearts <= 0) {
                setTimeout(() => {
                    document.getElementById('quiz-ui').classList.remove('show');
                    showAdModal();
                }, 500);
            }
        }
    }

    function useRemoveTwo() {
        const q = gameState.questions[gameState.activeIdx];
        const btns = Array.from(document.querySelectorAll('.ans-btn')).filter(b => b.innerText !== q.a);
        for(let i=0; i<2; i++) {
            const r = Math.floor(Math.random()*btns.length);
            btns[r].classList.add('removed');
            btns.splice(r,1);
        }
        gameState.score -= 50;
        const usedKey = `${gameState.lang}_${gameState.currentCat}_${gameState.activeIdx}`;
        gameState.usedRemove[usedKey] = true;
        document.getElementById('remove-two-btn').style.display = 'none';
        save(); updateUI();
    }

    function showAdModal() { document.getElementById('ad-modal').style.display = 'flex'; }
    function closeAdModal() { document.getElementById('ad-modal').style.display = 'none'; }

    function startAd() {
        let sec = 5;
        const btn = document.getElementById('watch-ad-btn');
        const tmr = document.getElementById('ad-timer');
        btn.style.display = 'none';
        tmr.style.display = 'block';
        const inter = setInterval(() => {
            tmr.innerText = sec;
            sec--;
            if(sec < 0) {
                clearInterval(inter);
                gameState.hearts = 8;
                save(); updateUI();
                closeAdModal();
                btn.style.display = 'block';
                tmr.style.display = 'none';
            }
        }, 1000);
    }
    window.onload = init;
</script>
</body>
</html>
