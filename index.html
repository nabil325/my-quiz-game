<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="logo.png">
    <meta property="og:image" content="logo.png">
    <meta property="og:title" content="IQ Ø«Ù‚Ø§ÙØ© - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ©">
    <meta property="og:description" content="Ø§Ø®ØªØ¨Ø± Ø°ÙƒØ§Ø¡Ùƒ ÙˆÙ…Ø¹Ù„ÙˆÙ…Ø§ØªÙƒ Ø§Ù„Ø¹Ø§Ù…Ø© ÙÙŠ Ø±Ø­Ù„Ø© Ù…Ù…ØªØ¹Ø© Ø¹Ø¨Ø± Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª.">
    
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">

    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>
    
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3940256099942544" crossorigin="anonymous"></script>
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>IQ Ø«Ù‚Ø§ÙØ© - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ©</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&family=Poppins:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --gold: #ffd700;
            --blue: #0ea5e9;
            --glass: rgba(255, 255, 255, 0.1);
            --dark-glass: rgba(0, 0, 0, 0.85);
            --danger: #ff4d4d;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            width: 100%;
            height: 100%;
        }

        body {
            font-family: 'Cairo', sans-serif;
            color: white;
            background-color: #000;
            overflow: hidden;
        }

        #offline-warning {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: var(--danger);
            color: white;
            text-align: center;
            padding: 10px;
            font-size: 0.9rem;
            z-index: 10000;
            display: none;
            font-weight: bold;
        }

        /* === Ø§Ù„Ø®Ù„ÙÙŠØ§Øª === */
        .bg-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -10;
            background: linear-gradient(135deg, #0f0f0f 0%, #1a1a2e 100%);
        }

        .bg-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            transition: opacity 1s ease-in-out;
            opacity: 1;
            z-index: 1;
        }

        .bg-layer.hidden {
            opacity: 0;
            pointer-events: none;
        }

        #base-bg {
            background: linear-gradient(135deg, rgba(15,15,15,0.7) 0%, rgba(26,26,46,0.7) 100%);
            z-index: 1;
        }

        #category-bg {
            background-size: cover;
            background-position: center;
        }

        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.3);
            z-index: 2;
        }

        /* === Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ === */
        .top-bar {
            position: fixed;
            top: 0;
            width: 100%;
            padding: 10px 15px;
            display: none;
            justify-content: space-between;
            align-items: center;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(15px);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .top-right, .top-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .player-badge {
            display: flex;
            align-items: center;
            gap: 6px;
            background: rgba(255,255,255,0.1);
            padding: 5px 10px;
            border-radius: 50px;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .player-avatar {
            width: 26px;
            height: 26px;
            background: var(--gold);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: black;
            font-weight: 900;
            font-size: 0.8rem;
        }

        .hearts-group {
            display: flex;
            align-items: center;
            gap: 4px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 77, 77, 0.5);
            padding: 3px 6px;
            border-radius: 50px;
        }

        .stat-badge {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            border-radius: 50px;
            font-size: 0.8rem;
            font-weight: 900;
        }

        .recharge-mini-btn {
            background: #ff4d4d;
            color: white;
            border: none;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            font-size: 1rem;
            cursor: pointer;
            font-weight: bold;
        }

        .exit-arrow-btn {
            position: fixed;
            top: 70px;
            right: 15px;
            background: var(--gold);
            color: black;
            border: none;
            width: 45px;
            height: 45px;
            border-radius: 12px;
            font-size: 1.5rem;
            font-weight: 900;
            cursor: pointer;
            z-index: 1001;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .icon-btn {
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.2);
            width: 36px;
            height: 36px;
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1rem;
        }

        /* === Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø§Ø³Ù… === */
        .name-input-screen {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(15px);
            z-index: 5000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .name-box {
            background: #111;
            padding: 40px 30px;
            border-radius: 30px;
            border: 2px solid var(--gold);
            text-align: center;
            width: 85%;
            max-width: 400px;
        }

        .name-box h2 {
            color: var(--gold);
            margin-bottom: 10px;
        }

        .name-box input {
            width: 100%;
            padding: 12px;
            border-radius: 12px;
            border: 1px solid #333;
            margin: 20px 0;
            font-size: 1.1rem;
            text-align: center;
            background: #222;
            color: white;
            box-sizing: border-box;
            font-family: 'Cairo';
        }

        /* === Ø§Ù„Ø´Ø§Ø´Ø§Øª === */
        .screen {
            position: relative;
            z-index: 10;
            height: 100vh;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 20px;
            box-sizing: border-box;
        }

        .screen.active {
            display: flex;
        }

        .fact-container {
            background: rgba(0,0,0,0.6);
            padding: 25px;
            border-radius: 25px;
            margin: 20px;
            max-width: 400px;
            min-height: 140px;
            border: 1px solid rgba(255,255,255,0.1);
            overflow-y: auto;
        }

        .gold-btn {
            background: var(--gold);
            color: black;
            border: none;
            padding: 16px 80px;
            border-radius: 60px;
            font-size: 1.3rem;
            font-weight: 900;
            cursor: pointer;
            transition: 0.3s;
            font-family: 'Cairo';
        }

        .gold-btn:hover:not(:disabled) {
            transform: scale(1.05);
        }

        .gold-btn:disabled {
            background: #444;
            color: #888;
            cursor: not-allowed;
        }

        .lang-toggle-container {
            margin-bottom: 25px;
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        .lang-btn {
            background: rgba(0,0,0,0.5);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            padding: 10px 15px;
            border-radius: 15px;
            cursor: pointer;
            font-weight: 900;
        }

        .lang-btn.active-lang {
            background: var(--blue);
            border-color: var(--blue);
        }

        .cat-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            width: 100%;
            max-width: 450px;
        }

        .cat-btn {
            background: rgba(0,0,0,0.6);
            padding: 25px 10px;
            border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.2);
            cursor: pointer;
            font-weight: 900;
            transition: 0.3s;
            color: white;
            font-size: 1.1rem;
        }

        .cat-btn:hover {
            background: rgba(0,0,0,0.8);
        }

        /* === Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª === */
        .map-view {
            width: 100%;
            height: 100vh;
            overflow-y: auto;
            padding: 150px 0;
            display: flex;
            flex-direction: column-reverse;
            align-items: center;
            gap: 40px;
        }

        .lvl-node {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.5);
            border: 4px solid rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.6rem;
            font-weight: 900;
            cursor: default;
            transition: 0.4s;
            color: white;
            position: relative;
            z-index: 2;
        }

        .lvl-node.completed {
            background: var(--gold);
            border-color: #b8860b;
            color: black;
            cursor: pointer;
        }

        .lvl-node.current {
            background: white;
            border-color: var(--gold);
            color: black;
            cursor: pointer;
            animation: pulse 2s infinite;
            z-index: 5;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        /* === Ø§Ø®ØªØ¨Ø§Ø± === */
        .quiz-container {
            position: fixed;
            bottom: -100%;
            left: 0;
            width: 100%;
            background: rgba(15, 15, 15, 0.98);
            backdrop-filter: blur(30px);
            border-radius: 35px 35px 0 0;
            border-top: 3px solid var(--gold);
            padding: 30px 20px;
            box-sizing: border-box;
            z-index: 2000;
            transition: 0.6s;
            max-height: 75vh;
            overflow-y: auto;
        }

        .quiz-container.show {
            bottom: 0;
        }

        .ans-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 25px;
        }

        .ans-btn {
            background: rgba(255,255,255,0.07);
            padding: 18px;
            border-radius: 15px;
            cursor: pointer;
            border: 1px solid rgba(255,255,255,0.1);
            font-weight: bold;
            color: white;
            transition: 0.2s;
            font-family: 'Cairo';
        }

        .ans-btn:hover {
            background: rgba(255,255,255,0.12);
        }

        .ans-btn.wrong {
            background: #ef4444 !important;
        }

        .ans-btn.correct {
            background: #10b981 !important;
        }

        /* === Ù„ÙˆØ­Ø© Ø§Ù„ØªØ±ØªÙŠØ¨ === */
        .leaderboard-modal {
            position: fixed;
            inset: 0;
            display: none;
            align-items: center;
            justify-content: center;
            background: rgba(0,0,0,0.9);
            z-index: 6000;
        }

        .leaderboard-box {
            background: #111;
            padding: 25px;
            border-radius: 25px;
            width: 90%;
            max-width: 400px;
            border: 1px solid var(--gold);
        }

        .leader-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #333;
        }

        /* === Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª === */
        .ad-modal {
            position: fixed;
            inset: 0;
            display: none;
            align-items: center;
            justify-content: center;
            background: rgba(0,0,0,0.9);
            z-index: 4000;
        }

        .ad-box {
            background: #222;
            padding: 35px;
            border-radius: 25px;
            width: 85%;
            max-width: 400px;
            text-align: center;
            border: 2px solid var(--gold);
        }

        .glass-btn {
            background: rgba(0,0,0,0.5);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            padding: 12px 25px;
            border-radius: 15px;
            cursor: pointer;
            font-weight: 900;
            font-family: 'Cairo';
        }

        .glass-btn:hover {
            background: rgba(0,0,0,0.7);
        }

        .logo-wrapper {
            margin-bottom: 30px;
        }

        .main-logo-styled {
            font-size: 4.5rem;
            font-weight: 900;
            margin: 0;
            letter-spacing: -2px;
            background: linear-gradient(180deg, #fff 30%, var(--gold) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            display: inline-block;
        }

        .logo-subtitle {
            display: block;
            font-size: 0.9rem;
            color: var(--gold);
            letter-spacing: 5px;
            margin-top: -10px;
            font-weight: 700;
            text-transform: uppercase;
        }

        @media (max-width: 600px) {
            .main-logo-styled { font-size: 3rem; }
            .cat-grid { max-width: 300px; }
        }
    </style>
</head>
<body>

<div id="offline-warning"></div>

<div class="bg-container">
    <div id="base-bg" class="bg-layer"></div>
    <div id="category-bg" class="bg-layer hidden"></div>
    <div class="overlay"></div>
</div>

<audio id="bg-audio" src="./jazz-music-466491.mp3" loop></audio>

<button id="main-exit-btn" onclick="goBack()" class="exit-arrow-btn">â”</button>

<div id="top-bar" class="top-bar">
    <div class="top-right">
        <div class="player-badge">
            <div class="player-avatar" id="avatar-char">?</div>
            <span id="player-name-display">...</span>
        </div>
        <div class="hearts-group">
            <div class="stat-badge" style="color: #ff4d4d;">
                <span>â¤ï¸</span> <span id="hearts-val">5</span>
            </div>
            <button onclick="showAdModal('manual')" class="recharge-mini-btn">+</button>
        </div>
        <div class="stat-badge" style="color: var(--gold);">
            <span>ğŸ†</span> <span id="score-val">0</span>
        </div>
    </div>
    <div class="top-left">
        <button id="mute-btn" class="icon-btn">ğŸ”Š</button>
    </div>
</div>

<div id="name-screen" class="name-input-screen">
    <div class="name-box">
        <h2>Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ!</h2>
        <p>Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ Ù„ØªØ¨Ø¯Ø£ Ø±Ø­Ù„Ø© Ø§Ù„Ø«Ù‚Ø§ÙØ©</p>
        <input type="text" id="player-name-input" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ Ù‡Ù†Ø§..." maxlength="15">
        <button onclick="submitName()" class="gold-btn" style="padding: 15px 50px;">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¢Ù†</button>
    </div>
</div>

<div id="scr-start" class="screen active">
    <div class="logo-wrapper">
        <h1 class="main-logo-styled">IQ Ø«Ù‚Ø§ÙØ©</h1>
        <span class="logo-subtitle">GLOBAL EDITION</span>
    </div>
    <div class="fact-container"><p id="fact-txt" style="font-size: 1.1rem; line-height: 1.6;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p></div>
    <div style="display: flex; flex-direction: column; gap: 15px;">
        <button id="btn-start" onclick="showCats()" class="gold-btn">Ø§Ø³ØªÙ…Ø±Ø§Ø±</button>
        <button id="btn-leaderboard" onclick="openLeaderboard()" class="glass-btn" style="color: var(--gold); margin-top: 10px;">ğŸ† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ†</button>
    </div>
</div>

<div id="scr-cats" class="screen">
    <h2 style="margin-bottom: 20px; font-size: 1.8rem;">Ø§Ø®ØªØ± Ø§Ù„ØªØµÙ†ÙŠÙ</h2>
    <div class="lang-toggle-container">
        <button class="lang-btn active-lang" onclick="setLanguage('ar')">Ar ğŸ‡¸ğŸ‡¦</button>
        <button class="lang-btn" onclick="setLanguage('en')">En ğŸ‡ºğŸ‡¸</button>
        <button class="lang-btn" onclick="setLanguage('es')">Es ğŸ‡ªğŸ‡¸</button>
        <button class="lang-btn" onclick="setLanguage('fr')">Fr ğŸ‡«ğŸ‡·</button>
    </div>
    <div class="cat-grid" id="cat-grid-container"></div>
</div>

<div id="scr-map" class="screen" style="padding:0; justify-content: flex-start;">
    <div class="map-view" id="map-cont"></div>
</div>

<div id="leaderboard-modal" class="leaderboard-modal">
    <div class="leaderboard-box">
        <h2 style="color: var(--gold); margin-bottom: 20px;">Ø£ÙØ¶Ù„ 10 Ù„Ø§Ø¹Ø¨ÙŠÙ†</h2>
        <div id="leaderboard-list"></div>
        <button onclick="closeLeaderboard()" class="glass-btn" style="width: 100%; margin-top: 15px;">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
</div>

<div class="quiz-container" id="quiz-ui">
    <div id="q-text" style="font-size: 1.3rem; font-weight: bold;"></div>
    <div class="ans-grid" id="ans-box"></div>
</div>

<div class="ad-modal" id="ad-modal">
    <div class="ad-box">
        <h3 id="txt-no-hearts" style="color:var(--gold);"></h3>
        <p id="txt-ad-desc"></p>
        <div id="ad-timer" style="display:none; font-size: 2.5rem; color: var(--gold); margin: 20px 0;">5</div>
        <div style="margin-top:25px; display: flex; flex-direction: column; gap: 10px;">
            <button id="watch-ad-btn" onclick="triggerRewardedAd()" class="gold-btn" style="padding: 12px;">ğŸ“º Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†</button>
            <button onclick="closeAdModal()" class="glass-btn">Ø±Ø¨Ù…Ø§ Ù„Ø§Ø­Ù‚Ø§Ù‹</button>
        </div>
    </div>
</div>

<script>
    // === Firebase ===
    const firebaseConfig = {
        apiKey: "AIzaSyCIXq5egNrR0dS5YI2L4BFnm3IGa11128Q",
        databaseURL: "https://iq-culture-default-rtdb.firebaseio.com/",
        projectId: "iq-culture"
    };

    try {
        firebase.initializeApp(firebaseConfig);
    } catch(e) {
        console.log('Firebase already initialized');
    }
    const db = firebase.database();

    // === Ø§Ù„Ø«ÙˆØ§Ø¨Øª ===
    const CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSJ4RCU1_iXMqLS3ApB1g8SjSrL2hbIAv-1VniqdMElnalov--mSDTpe9rjMxaWGCuP6gpxWV7OZDe1/pub?output=csv";
    const MAX_HEARTS = 5;
    const REGEN_TIME = 5 * 60 * 1000;

    // === Ø§Ù„Ø®Ù„ÙÙŠØ§Øª ===
    const CAT_BGS = {
        history: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1200 800'%3E%3Cdefs%3E%3ClinearGradient id='g1' x1='0%' y1='0%' x2='100%' y2='100%'%3E%3Cstop offset='0%' style='stop-color:rgb(139,69,19);stop-opacity:1' /%3E%3Cstop offset='100%' style='stop-color:rgb(184,134,11);stop-opacity:1' /%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='1200' height='800' fill='url(%23g1)'/%3E%3C/svg%3E",
        geo: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1200 800'%3E%3Cdefs%3E%3ClinearGradient id='g2' x1='0%' y1='0%' x2='100%' y2='100%'%3E%3Cstop offset='0%' style='stop-color:rgb(0,100,200);stop-opacity:1' /%3E%3Cstop offset='100%' style='stop-color:rgb(0,150,255);stop-opacity:1' /%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='1200' height='800' fill='url(%23g2)'/%3E%3C/svg%3E",
        science: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1200 800'%3E%3Cdefs%3E%3ClinearGradient id='g3' x1='0%' y1='0%' x2='100%' y2='100%'%3E%3Cstop offset='0%' style='stop-color:rgb(75,0,130);stop-opacity:1' /%3E%3Cstop offset='100%' style='stop-color:rgb(138,43,226);stop-opacity:1' /%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='1200' height='800' fill='url(%23g3)'/%3E%3C/svg%3E",
        general: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1200 800'%3E%3Cdefs%3E%3ClinearGradient id='g4' x1='0%' y1='0%' x2='100%' y2='100%'%3E%3Cstop offset='0%' style='stop-color:rgb(75,0,0);stop-opacity:1' /%3E%3Cstop offset='100%' style='stop-color:rgb(139,0,0);stop-opacity:1' /%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='1200' height='800' fill='url(%23g4)'/%3E%3C/svg%3E",
        sports: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1200 800'%3E%3Cdefs%3E%3ClinearGradient id='g5' x1='0%' y1='0%' x2='100%' y2='100%'%3E%3Cstop offset='0%' style='stop-color:rgb(0,100,0);stop-opacity:1' /%3E%3Cstop offset='100%' style='stop-color:rgb(0,200,0);stop-opacity:1' /%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='1200' height='800' fill='url(%23g5)'/%3E%3C/svg%3E"
    };

    // === Ø­Ø§Ù„Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© ===
    let gameState = {
        playerName: localStorage.getItem('iq_player_name') || "",
        score: parseInt(localStorage.getItem('iq_score')) || 0,
        progress: JSON.parse(localStorage.getItem('iq_prog')) || {},
        currentCat: '',
        questions: [],
        activeIdx: 0,
        hearts: parseInt(localStorage.getItem('iq_hearts')) || MAX_HEARTS,
        lastHeartTime: parseInt(localStorage.getItem('iq_last_heart_time')) || Date.now(),
        muted: (localStorage.getItem('iq_muted') === 'true') || false,
        usedRemove: JSON.parse(localStorage.getItem('iq_rem_used') || '{}'),
        lang: localStorage.getItem('iq_lang') || 'ar',
        adCounter: 0
    };

    // === Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù„ØºØ§Øª ===
    const langConfig = {
        ar: {
            factsGid: "605574246",
            cats: [
                { name: "â³ Ø§Ù„ØªØ§Ø±ÙŠØ®", gid: "11216236", key: "history" },
                { name: "ğŸŒ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠØ§", gid: "99625756", key: "geo" },
                { name: "ğŸ§¬ Ø§Ù„Ø¹Ù„ÙˆÙ…", gid: "1843208636", key: "science" },
                { name: "ğŸ’¡ Ø«Ù‚Ø§ÙØ© Ø¹Ø§Ù…Ø©", gid: "564130158", key: "general" },
                { name: "âš½ Ø§Ù„Ø±ÙŠØ§Ø¶Ø©", gid: "0", key: "sports" }
            ]
        },
        en: {
            factsGid: "259198059",
            cats: [
                { name: "â³ History", gid: "1950805065", key: "history" },
                { name: "ğŸŒ Geography", gid: "1899297807", key: "geo" },
                { name: "ğŸ§¬ Science", gid: "407039200", key: "science" },
                { name: "ğŸ’¡ General", gid: "1044248022", key: "general" },
                { name: "âš½ Sports", gid: "1559005659", key: "sports" }
            ]
        },
        es: {
            factsGid: "1911794502",
            cats: [
                { name: "â³ Historia", gid: "948777647", key: "history" },
                { name: "ğŸŒ GeografÃ­a", gid: "1233201488", key: "geo" },
                { name: "ğŸ§¬ Ciencia", gid: "2028449800", key: "science" },
                { name: "ğŸ’¡ Cultura General", gid: "1662832315", key: "general" },
                { name: "âš½ Deportes", gid: "1795176380", key: "sports" }
            ]
        },
        fr: {
            factsGid: "1356278776",
            cats: [
                { name: "â³ Histoire", gid: "1692460075", key: "history" },
                { name: "ğŸŒ GÃ©ographie", gid: "1888258036", key: "geo" },
                { name: "ğŸ§¬ Sciences", gid: "1043839601", key: "science" },
                { name: "ğŸ’¡ Culture GÃ©nÃ©rale", gid: "1000789609", key: "general" },
                { name: "âš½ Sports", gid: "942675202", key: "sports" }
            ]
        }
    };

    const audioEl = document.getElementById('bg-audio');
    const muteBtn = document.getElementById('mute-btn');

    // === ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø®Ù„ÙÙŠØ© ===
    function updateBackground(catKey) {
        const catLayer = document.getElementById('category-bg');
        const baseLayer = document.getElementById('base-bg');

        if (!catKey) {
            catLayer.classList.add('hidden');
            baseLayer.classList.remove('hidden');
            return;
        }

        if (CAT_BGS[catKey]) {
            baseLayer.classList.add('hidden');
            catLayer.classList.remove('hidden');
            catLayer.style.backgroundImage = `linear-gradient(135deg, rgba(0,0,0,0.3) 0%, rgba(0,0,0,0.2) 100%), url('${CAT_BGS[catKey]}')`;
        }
    }

    // === Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ ===
    function checkConnection() {
        const warning = document.getElementById('offline-warning');
        if (!navigator.onLine) {
            warning.innerText = "âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª";
            warning.style.display = 'block';
        } else {
            warning.style.display = 'none';
        }
    }

    window.addEventListener('online', checkConnection);
    window.addEventListener('offline', checkConnection);

    // === Ø§Ù„Ø±Ø¬ÙˆØ¹ ===
    function goBack() {
        const quizUI = document.getElementById('quiz-ui');
        if (quizUI.classList.contains('show')) {
            quizUI.classList.remove('show');
            return;
        }

        const mapScreen = document.getElementById('scr-map');
        const catsScreen = document.getElementById('scr-cats');

        if (mapScreen.classList.contains('active')) {
            updateBackground(null);
            switchScreen('scr-cats');
        } else if (catsScreen.classList.contains('active')) {
            switchScreen('scr-start');
            document.getElementById('top-bar').style.display = 'none';
            document.getElementById('main-exit-btn').style.display = 'none';
        }
    }

    function switchScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }

    // === Ø§Ù„ØªÙ‡ÙŠØ¦Ø© ===
    function init() {
        checkConnection();
        checkPlayerName();
        loadFact();
        renderCats();
        updateUI();
        muteBtn.onclick = toggleMute;
        document.getElementById('watch-ad-btn').onclick = triggerRewardedAd;
        setInterval(checkHeartRegen, 1000);
    }

    // === ØªØ¬Ø¯ÙŠØ¯ Ø§Ù„Ù‚Ù„ÙˆØ¨ ===
    function checkHeartRegen() {
        if (gameState.hearts < MAX_HEARTS) {
            const now = Date.now();
            const diff = now - gameState.lastHeartTime;

            if (diff >= REGEN_TIME) {
                gameState.hearts++;
                gameState.lastHeartTime = now;
                save();
                updateUI();
            }
        }
    }

    // === Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨ ===
    function checkPlayerName() {
        if (!gameState.playerName) {
            document.getElementById('name-screen').style.display = 'flex';
        } else {
            updatePlayerDisplay();
        }
    }

    function submitName() {
        let input = document.getElementById('player-name-input').value.trim();
        if (input.length < 3) {
            alert("Ø§Ù„Ø§Ø³Ù… Ù‚ØµÙŠØ± Ø¬Ø¯Ø§Ù‹!");
            return;
        }
        gameState.playerName = input.substring(0, 15);
        localStorage.setItem('iq_player_name', gameState.playerName);
        document.getElementById('name-screen').style.display = 'none';
        updatePlayerDisplay();
        save();
    }

    function updatePlayerDisplay() {
        const name = gameState.playerName || "...";
        document.getElementById('player-name-display').innerText = name;
        document.getElementById('avatar-char').innerText = name.charAt(0).toUpperCase();
    }

    // === Ù„ÙˆØ­Ø© Ø§Ù„ØªØ±ØªÙŠØ¨ ===
    function openLeaderboard() {
        document.getElementById('leaderboard-modal').style.display = 'flex';
        const listCont = document.getElementById('leaderboard-list');
        listCont.innerHTML = '<p>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>';

        db.ref('leaderboard').orderByChild('score').limitToLast(10).once('value', (snapshot) => {
            let board = [];
            snapshot.forEach((child) => {
                board.push(child.val());
            });
            board.reverse();
            listCont.innerHTML = '';

            board.forEach((entry, i) => {
                const rank = (i === 0) ? "ğŸ¥‡" : (i === 1) ? "ğŸ¥ˆ" : (i === 2) ? "ğŸ¥‰" : (i + 1);
                const item = document.createElement('div');
                item.className = 'leader-item';
                item.innerHTML = `<span>${rank} ${entry.name}</span><span style="color:var(--gold);">${entry.score}</span>`;
                listCont.appendChild(item);
            });
        }).catch(e => {
            listCont.innerHTML = '<p style="color: red;">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„</p>';
            console.error(e);
        });
    }

    function closeLeaderboard() {
        document.getElementById('leaderboard-modal').style.display = 'none';
    }

    // === Ø§Ù„Ù„ØºØ§Øª ===
    function setLanguage(l) {
        gameState.lang = l;
        localStorage.setItem('iq_lang', l);
        loadFact();
        renderCats();
    }

    // === ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ù‚Ø§Ø¦Ù‚ ===
    function loadFact() {
        const conf = langConfig[gameState.lang];
        const factBox = document.getElementById('fact-txt');
        factBox.innerText = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...';

        fetch(CSV + "&gid=" + conf.factsGid)
            .then(r => r.text())
            .then(d => {
                const lines = d.split(/\r?\n/).slice(1);
                if (lines.length > 0) {
                    const fact = lines[Math.floor(Math.random() * lines.length)].split(',')[0].replace(/"/g, '');
                    factBox.innerText = fact;
                }
            })
            .catch(e => {
                factBox.innerText = 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„';
                console.error(e);
            });
    }

    // === Ø¹Ø±Ø¶ Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª ===
    function renderCats() {
        const container = document.getElementById('cat-grid-container');
        container.innerHTML = '';
        const conf = langConfig[gameState.lang];

        conf.cats.forEach(c => {
            const btn = document.createElement('div');
            btn.className = 'cat-btn';
            if(c.key === 'sports') btn.style.gridColumn = 'span 2';
            btn.innerText = c.name;
            btn.onclick = () => startCat(c.gid, c.key);
            container.appendChild(btn);
        });
    }

    // === Ø§Ù„Ø­ÙØ¸ ===
    function save() {
        localStorage.setItem('iq_score', gameState.score);
        localStorage.setItem('iq_prog', JSON.stringify(gameState.progress));
        localStorage.setItem('iq_hearts', gameState.hearts);
        localStorage.setItem('iq_last_heart_time', gameState.lastHeartTime);
        localStorage.setItem('iq_muted', gameState.muted);
        localStorage.setItem('iq_rem_used', JSON.stringify(gameState.usedRemove));

        if(gameState.playerName) {
            db.ref('leaderboard/' + gameState.playerName).set({
                name: gameState.playerName,
                score: gameState.score
            });
        }
    }

    function updateUI() {
        document.getElementById('score-val').innerText = gameState.score;
        document.getElementById('hearts-val').innerText = gameState.hearts;
        muteBtn.innerText = gameState.muted ? 'ğŸ”‡' : 'ğŸ”Š';
        updatePlayerDisplay();
    }

    // === Ø§Ù„ØµÙˆØª ===
    function toggleMute() {
        gameState.muted = !gameState.muted;
        gameState.muted ? audioEl.pause() : audioEl.play().catch(()=>{});
        save();
        updateUI();
    }

    function showCats() {
        document.getElementById('top-bar').style.display = 'flex';
        document.getElementById('main-exit-btn').style.display = 'flex';
        if(!gameState.muted) audioEl.play().catch(()=>{});
        switchScreen('scr-cats');
    }

    // === Ø¨Ø¯Ø¡ Ø§Ù„ØªØµÙ†ÙŠÙ ===
    async function startCat(gid, key) {
        if(!navigator.onLine) {
            alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª");
            return;
        }

        gameState.currentCat = key;
        updateBackground(key);
        switchScreen('scr-map');

        try {
            const r = await fetch(CSV + "&gid=" + gid);
            const d = await r.text();
            gameState.questions = d.split(/\r?\n/).slice(1)
                .map(row => {
                    const c = row.split(',').map(x => x.trim().replace(/"/g, ''));
                    return { q: c[0], opts: [c[1], c[2], c[3], c[4]], a: c[5] };
                })
                .filter(q => q.q);

            renderMap(true);
        } catch(e) {
            console.error(e);
            alert('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©');
        }
    }

    // === Ø±Ø³Ù… Ø§Ù„Ø®Ø±ÙŠØ·Ø© ===
    function renderMap(shouldScroll = false) {
        const cont = document.getElementById('map-cont');
        const progKey = `${gameState.lang}_${gameState.currentCat}`;
        const unlocked = gameState.progress[progKey] || 1;

        cont.innerHTML = '';

        gameState.questions.forEach((_, i) => {
            const levelNum = i + 1;
            const node = document.createElement('div');
            node.className = 'lvl-node';
            node.innerText = levelNum;

            node.style.transform = `translateX(${(i % 2 === 0) ? "40px" : "-40px"})`;

            if (levelNum < unlocked) {
                node.classList.add('completed');
                node.onclick = () => openQuiz(i);
            } else if (levelNum === unlocked) {
                node.classList.add('current');
                node.id = "target-node";
                node.onclick = () => openQuiz(i);
            }

            cont.appendChild(node);
        });

        if (shouldScroll) {
            setTimeout(() => {
                const target = document.getElementById('target-node');
                if (target) target.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 100);
        }
    }

    // === ÙØªØ­ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± ===
    function openQuiz(idx) {
        if(gameState.hearts <= 0) {
            showAdModal('hearts');
            return;
        }

        gameState.activeIdx = idx;
        const q = gameState.questions[idx];

        document.getElementById('q-text').innerText = q.q;
        const box = document.getElementById('ans-box');
        box.innerHTML = '';

        const letters = ['a', 'b', 'c', 'd'];
        let optionsList = q.opts.map((text, i) => ({ text, originalLetter: letters[i] }));
        optionsList.sort(() => Math.random() - 0.5);

        optionsList.forEach((item) => {
            const b = document.createElement('div');
            b.className = 'ans-btn';
            b.innerText = item.text;
            b.onclick = () => checkAns(b, item.originalLetter, q.a);
            box.appendChild(b);
        });

        document.getElementById('quiz-ui').classList.add('show');
    }

    // === Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© ===
    function checkAns(btn, selectedLetter, correctLetter) {
        const progKey = `${gameState.lang}_${gameState.currentCat}`;

        if(selectedLetter.toLowerCase().trim() === correctLetter.toLowerCase().trim()) {
            btn.classList.add('correct');
            gameState.score += 10;
            gameState.adCounter++;

            if(gameState.activeIdx + 1 === (gameState.progress[progKey] || 1)) {
                gameState.progress[progKey] = (gameState.progress[progKey] || 1) + 1;
            }

            save();
            updateUI();

            setTimeout(() => {
                document.getElementById('quiz-ui').classList.remove('show');
                renderMap(false);
            }, 800);
        } else {
            btn.classList.add('wrong');
            gameState.hearts--;

            if(gameState.hearts <= 0) {
                save();
                updateUI();
                setTimeout(() => {
                    document.getElementById('quiz-ui').classList.remove('show');
                    showAdModal('hearts');
                }, 800);
            } else {
                save();
                updateUI();
                setTimeout(() => {
                    document.getElementById('quiz-ui').classList.remove('show');
                }, 800);
            }
        }
    }

    // === Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª ===
    function showAdModal(type) {
        const noHearts = document.getElementById('txt-no-hearts');
        const adDesc = document.getElementById('txt-ad-desc');

        if(type === 'hearts') {
            noHearts.innerText = "Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù‚Ù„ÙˆØ¨!";
            adDesc.innerText = "Ø´Ø§Ù‡Ø¯ Ø¥Ø¹Ù„Ø§Ù† Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù‚Ù„ÙˆØ¨ ÙƒØ§Ù…Ù„Ø©.";
        }

        document.getElementById('ad-modal').style.display = 'flex';
    }

    function closeAdModal() {
        document.getElementById('ad-modal').style.display = 'none';
    }

    function triggerRewardedAd() {
        let sec = 3;
        const btn = document.getElementById('watch-ad-btn');
        const tmr = document.getElementById('ad-timer');

        btn.style.display = 'none';
        tmr.style.display = 'block';

        const inter = setInterval(() => {
            tmr.innerText = sec;
            sec--;

            if(sec < 0) {
                clearInterval(inter);
                gameState.hearts = MAX_HEARTS;
                gameState.lastHeartTime = Date.now();
                save();
                updateUI();
                closeAdModal();
                btn.style.display = 'block';
                tmr.style.display = 'none';
            }
        }, 1000);
    }

    // === Ø¨Ø¯Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ===
    window.onload = init;
</script>

</body>
</html>
